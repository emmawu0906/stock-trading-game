<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0a0e17">
  <title>è‚¡æ°‘é—¯å…³ï¼šå¾·æ˜åˆ©å®æˆ˜</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    :root {
      --bg-1: #0a0e17;
      --bg-2: #111827;
      --bg-3: #1e293b;
      --bg-4: #334155;
      --text-1: #f1f5f9;
      --text-2: #94a3b8;
      --text-3: #64748b;
      --up: #ef4444;
      --down: #22c55e;
      --accent: #3b82f6;
      --gold: #eab308;
    }
    
    html, body {
      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background: var(--bg-1);
      color: var(--text-1);
      font-size: 14px;
      min-height: 100vh;
      touch-action: manipulation;
    }
    
    .safe-top { padding-top: env(safe-area-inset-top, 12px); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 12px); }
    
    .screen { display: none; min-height: 100vh; }
    .screen.active { display: flex; flex-direction: column; }
    
    /* ===== ä¸»èœå• ===== */
    .menu-screen { background: var(--bg-1); padding: 20px 16px; }
    .menu-header { text-align: center; padding: 24px 0 20px; }
    .menu-title {
      font-size: 24px; font-weight: 800;
      background: linear-gradient(135deg, #f59e0b, #ef4444, #ec4899);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }
    .menu-subtitle { color: var(--text-3); font-size: 12px; }
    .stats-bar { display: flex; justify-content: center; gap: 32px; padding: 16px; margin: 16px 0; background: var(--bg-2); border-radius: 12px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 11px; color: var(--text-3); margin-top: 4px; }
    .level-grid { display: flex; flex-direction: column; gap: 12px; }
    .level-card { background: var(--bg-2); border: 1px solid var(--bg-4); border-radius: 12px; padding: 16px; cursor: pointer; transition: all .2s; }
    .level-card:active { border-color: var(--accent); transform: scale(0.98); }
    .level-card.locked { opacity: 0.4; pointer-events: none; }
    .level-card.completed { border-color: var(--gold); }
    .level-header { display: flex; align-items: flex-start; gap: 14px; margin-bottom: 10px; }
    .level-num { font-size: 36px; font-weight: 900; color: var(--accent); line-height: 1; }
    .level-info h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .level-info p { font-size: 12px; color: var(--text-3); }
    .level-meta { display: flex; gap: 16px; font-size: 11px; color: var(--text-3); padding-left: 50px; }
    .level-target { color: var(--up); font-weight: 600; }
    
    /* ===== æ¸¸æˆç•Œé¢ ===== */
    .game-screen { background: var(--bg-1); }
    .game-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: var(--bg-2); border-bottom: 1px solid var(--bg-4); }
    .back-btn { background: none; border: 1px solid var(--bg-4); color: var(--text-2); border-radius: 6px; padding: 6px 12px; font-size: 12px; cursor: pointer; }
    .level-badge { font-weight: 700; color: var(--accent); font-size: 14px; }
    .assets-display { text-align: right; }
    .total-assets { font-size: 16px; font-weight: 600; }
    .profit-rate { font-size: 12px; }
    .profit-rate.up { color: var(--up); }
    .profit-rate.down { color: var(--down); }
    
    /* ä»·æ ¼æ˜¾ç¤º */
    .price-section { background: var(--bg-2); padding: 16px; text-align: center; border-bottom: 1px solid var(--bg-4); }
    .stock-name { font-size: 13px; color: var(--text-2); margin-bottom: 6px; }
    .current-price { font-size: 32px; font-weight: 800; margin-bottom: 6px; }
    .current-price.up { color: var(--up); }
    .current-price.down { color: var(--down); }
    .price-meta { display: flex; justify-content: center; gap: 16px; font-size: 12px; color: var(--text-3); }
    .price-meta b.up { color: var(--up); }
    .price-meta b.down { color: var(--down); }
    
    /* å›¾è¡¨åŒºåŸŸ - åŒ…å«Kçº¿+æˆäº¤é‡+MACD */
    .chart-area { background: var(--bg-1); padding: 8px; }
    .chart-row { position: relative; }
    .chart-canvas { width: 100%; display: block; }
    #kline-chart { height: 160px; background: #0c1018; border-radius: 6px; }
    #vol-chart { height: 50px; background: #0c1018; }
    #macd-chart { height: 50px; background: #0c1018; border-radius: 0 0 6px 6px; }
    
    /* ä¿¡å·åŒº */
    .signal-section { background: var(--bg-2); padding: 10px 16px; border-bottom: 1px solid var(--bg-4); }
    .section-title { font-size: 12px; font-weight: 600; color: var(--text-2); margin-bottom: 8px; }
    .signal-list { display: flex; flex-direction: column; gap: 6px; }
    .signal-item { background: var(--bg-3); border-radius: 6px; padding: 8px 10px; font-size: 12px; border-left: 3px solid var(--text-3); }
    .signal-item.buy { border-color: var(--up); background: rgba(239,68,68,0.1); }
    .signal-item.sell { border-color: var(--down); background: rgba(34,197,94,0.1); }
    .signal-item.warn { border-color: var(--gold); background: rgba(234,179,8,0.1); }
    
    /* æŒä»“ */
    .position-section { background: var(--bg-2); padding: 12px 16px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; border-bottom: 1px solid var(--bg-4); }
    .pos-item { text-align: center; }
    .pos-label { font-size: 10px; color: var(--text-3); margin-bottom: 3px; }
    .pos-value { font-size: 13px; font-weight: 600; }
    
    /* äº¤æ˜“åŒº */
    .trade-section { background: var(--bg-2); padding: 14px 16px; border-top: 1px solid var(--bg-4); }
    .trade-input-row { display: flex; gap: 8px; margin-bottom: 10px; }
    .trade-input { flex: 1; background: var(--bg-3); border: 1px solid var(--bg-4); border-radius: 8px; padding: 10px; color: var(--text-1); font-size: 16px; text-align: center; }
    .qty-btns { display: flex; gap: 6px; }
    .qty-btn { background: var(--bg-3); border: 1px solid var(--bg-4); border-radius: 6px; padding: 10px 10px; color: var(--text-1); font-size: 12px; cursor: pointer; }
    .qty-btn:active { background: var(--bg-4); }
    .trade-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn-buy { background: var(--up); border: none; border-radius: 8px; padding: 14px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; }
    .btn-sell { background: var(--down); border: none; border-radius: 8px; padding: 14px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; }
    .btn-buy:active, .btn-sell:active { opacity: 0.85; }
    .quick-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    .btn-quick { background: var(--bg-3); border: 1px solid var(--bg-4); border-radius: 6px; padding: 10px; color: var(--text-2); font-size: 12px; cursor: pointer; }
    .btn-quick:active { background: var(--bg-4); color: var(--text-1); }
    
    /* åº•éƒ¨ */
    .game-footer { background: var(--bg-2); padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--bg-4); }
    .day-progress { display: flex; flex-direction: column; gap: 4px; }
    .day-counter { font-size: 13px; color: var(--text-1); }
    .progress-bar { width: 90px; height: 4px; background: var(--bg-4); border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; }
    .next-day-btn { background: var(--accent); border: none; border-radius: 20px; padding: 10px 22px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; }
    .next-day-btn:active { opacity: 0.9; }
    
    /* Toast */
    .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-2); border: 1px solid var(--bg-4); border-radius: 12px; padding: 14px 20px; text-align: center; z-index: 1000; animation: fadeIn 0.2s; }
    @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
    .toast.success { border-color: var(--down); }
    .toast.error { border-color: var(--up); }
    
    /* å¼¹çª— */
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal.show { display: flex; }
    .modal-content { background: var(--bg-2); border: 1px solid var(--bg-4); border-radius: 16px; padding: 24px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto; }
    .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; text-align: center; color: var(--accent); }
    .modal-body { font-size: 14px; line-height: 1.8; margin-bottom: 20px; color: var(--text-1); }
    .modal-body p { margin-bottom: 12px; }
    .modal-body ul { padding-left: 20px; margin-bottom: 12px; }
    .modal-body li { margin-bottom: 6px; }
    .modal-body .hl { color: var(--gold); font-weight: 600; }
    .modal-body b { color: var(--accent); }
    .teach-box { background: var(--bg-3); border-radius: 8px; padding: 12px; margin: 12px 0; }
    .btn-primary { background: var(--accent); border: none; border-radius: 8px; padding: 14px; width: 100%; color: #fff; font-size: 15px; font-weight: 600; cursor: pointer; }
    .btn-primary:active { opacity: 0.9; }
    
    /* ç»“ç®— */
    .report-screen { background: var(--bg-1); padding: 40px 20px; text-align: center; }
    .report-title { font-size: 24px; font-weight: 800; margin-bottom: 24px; }
    .report-card { background: var(--bg-2); border: 1px solid var(--bg-4); border-radius: 16px; padding: 24px; margin-bottom: 20px; }
    .grade-badge { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: 800; margin: 0 auto 20px; }
    .grade-S { background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; }
    .grade-A { background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; }
    .grade-B { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; }
    .grade-C { background: linear-gradient(135deg, #eab308, #ca8a04); color: #000; }
    .grade-D { background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; }
    .report-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .report-stats .stat-item { background: var(--bg-3); padding: 14px; border-radius: 8px; }
    .report-stats .stat-value { font-size: 20px; font-weight: 700; }
    .report-stats .stat-label { font-size: 11px; color: var(--text-3); margin-top: 4px; }
    .report-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    .btn-secondary { background: var(--bg-3); border: 1px solid var(--bg-4); border-radius: 8px; padding: 14px; width: 100%; color: var(--text-1); font-size: 15px; font-weight: 600; cursor: pointer; }
    
    /* äº¤æ˜“å¼¹çª— */
    .trade-modal { position: fixed; inset: 0; z-index: 200; display: none; align-items: flex-end; justify-content: center; }
    .trade-modal.show { display: flex; }
    .trade-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
    .trade-card { position: relative; z-index: 1; background: var(--bg-2); border: 1px solid var(--bg-4); border-radius: 20px 20px 0 0; padding: 24px 20px; width: 100%; max-width: 500px; }
    .trade-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .trade-title { font-size: 18px; font-weight: 700; }
    .trade-title.buy { color: var(--up); }
    .trade-title.sell { color: var(--down); }
    .trade-close { background: none; border: none; color: var(--text-3); font-size: 24px; cursor: pointer; padding: 0 8px; }
    .trade-price-section { background: var(--bg-3); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center; }
    .trade-price-label { font-size: 12px; color: var(--text-3); margin-bottom: 4px; }
    .trade-price-value { font-size: 28px; font-weight: 800; }
    .trade-price-value.up { color: var(--up); }
    .trade-price-value.down { color: var(--down); }
    .trade-info-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; }
    .trade-info-row .label { color: var(--text-3); }
    .trade-info-row .value { color: var(--text-1); font-weight: 500; }
    .qty-section { margin-bottom: 20px; }
    .qty-label { font-size: 13px; color: var(--text-2); margin-bottom: 10px; }
    .qty-input-row { display: flex; gap: 10px; align-items: center; }
    .qty-input { flex: 1; background: var(--bg-3); border: 1px solid var(--bg-4); border-radius: 10px; padding: 14px; color: var(--text-1); font-size: 20px; font-weight: 600; text-align: center; }
    .qty-btn { background: var(--bg-3); border: 1px solid var(--bg-4); border-radius: 8px; padding: 12px 16px; color: var(--text-1); font-size: 13px; cursor: pointer; }
    .qty-btn:active { background: var(--bg-4); }
    .trade-summary { background: var(--bg-3); border-radius: 12px; padding: 14px; margin-bottom: 20px; }
    .trade-summary-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; }
    .trade-summary-row .label { color: var(--text-3); }
    .trade-summary-row .value { color: var(--text-1); }
    .trade-submit { width: 100%; border: none; border-radius: 12px; padding: 16px; font-size: 18px; font-weight: 700; cursor: pointer; }
    .trade-submit.buy { background: var(--up); color: #fff; }
    .trade-submit.sell { background: var(--down); color: #fff; }
    .trade-submit:active { opacity: 0.9; }
    .trade-submit:disabled { opacity: 0.5; cursor: not-allowed; }
    .trade-info-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; border-bottom: 1px solid var(--bg-4); }
    .trade-info-row .label { color: var(--text-3); }
    .trade-info-row .value { color: var(--text-1); font-weight: 500; }
    
    /* èµ„é‡‘é€‰æ‹©å¼¹çª— */
    .capital-modal { position: fixed; inset: 0; z-index: 200; display: none; align-items: center; justify-content: center; }
    .capital-modal.show { display: flex; }
    .capital-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
    .capital-card { position: relative; z-index: 1; background: var(--bg-2); border: 1px solid var(--bg-4); border-radius: 16px; padding: 24px; max-width: 380px; width: 90%; }
    .capital-title { font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 4px; }
    .capital-subtitle { text-align: center; color: var(--text-3); font-size: 13px; margin-bottom: 20px; }
    .capital-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
    .capital-option { background: var(--bg-3); border: 2px solid var(--bg-4); border-radius: 10px; padding: 10px 2px; text-align: center; cursor: pointer; transition: all .2s; }
    .capital-option:active { border-color: var(--accent); }
    .capital-option.selected { border-color: var(--gold); background: rgba(234,179,8,0.1); }
    .capital-amount { font-size: 16px; font-weight: 800; color: var(--text-1); }
    .capital-option.selected .capital-amount { color: var(--gold); }
    .capital-unit { font-size: 10px; color: var(--text-3); }
    .capital-actions { display: flex; gap: 10px; }
    .capital-actions .btn-primary { flex: 1; }
    .capital-actions .btn-secondary { flex: 1; }
  </style>
</head>
<body>
  <!-- ä¸»èœå• -->
  <div id="menu-screen" class="screen menu-screen active">
    <div class="safe-top"></div>
    <div class="menu-header">
      <div class="menu-title">ğŸ“ˆ è‚¡æ°‘é—¯å…³ï¼šå¾·æ˜åˆ©å®æˆ˜</div>
      <div class="menu-subtitle">ä»é›¶å¼€å§‹ï¼Œ5å…³ç³»ç»Ÿå­¦ä¹ Aè‚¡äº¤æ˜“</div>
    </div>
    <div class="stats-bar">
      <div class="stat-item"><div class="stat-value">5</div><div class="stat-label">å…³å¡</div></div>
      <div class="stat-item"><div class="stat-value">50</div><div class="stat-label">å¤©æ•°</div></div>
      <div class="stat-item"><div class="stat-value" id="completed-levels">0</div><div class="stat-label">å·²é€šå…³</div></div>
    </div>
    <div class="level-grid" id="level-grid"></div>
    <div class="safe-bottom"></div>
  </div>
  
  <!-- æ¸¸æˆç•Œé¢ -->
  <div id="game-screen" class="screen game-screen">
    <div class="safe-top"></div>
    <div class="game-header">
      <button class="back-btn" onclick="backToMenu()">â—€ è¿”å›</button>
      <span class="level-badge" id="level-badge">ç¬¬1å…³</span>
      <div class="assets-display">
        <div class="total-assets" id="total-assets">Â¥100,000</div>
        <div class="profit-rate" id="profit-rate">+0.00%</div>
      </div>
    </div>
    
    <div class="price-section">
      <div class="stock-name">å¾·æ˜åˆ© 001309</div>
      <div class="current-price up" id="current-price">Â¥250.00</div>
      <div class="price-meta">
        <span>æ¶¨è·Œ <b id="price-change">+0.00%</b></span>
        <span>é‡ <b id="day-volume">0ä¸‡</b></span>
        <span>é‡æ¯” <b id="vol-ratio">1.0x</b></span>
      </div>
    </div>
    
    <!-- å›¾è¡¨åŒºåŸŸï¼šKçº¿ + æˆäº¤é‡ + MACD -->
    <div class="chart-area">
      <div class="chart-row"><canvas id="kline-chart" class="chart-canvas"></canvas></div>
      <div class="chart-row"><canvas id="vol-chart" class="chart-canvas"></canvas></div>
      <div class="chart-row"><canvas id="macd-chart" class="chart-canvas"></canvas></div>
    </div>
    
    <div class="signal-section">
      <div class="section-title">ğŸ“¡ é‡ä»·ä¿¡å·</div>
      <div class="signal-list" id="signal-list"><div class="signal-item">ç‚¹å‡»ã€Œä¸‹ä¸€å¤©ã€å¼€å§‹</div></div>
    </div>
    
    <div class="position-section">
      <div class="pos-item"><div class="pos-label">æŒä»“</div><div class="pos-value" id="pos-shares">0è‚¡</div></div>
      <div class="pos-item"><div class="pos-label">æˆæœ¬</div><div class="pos-value" id="pos-cost">--</div></div>
      <div class="pos-item"><div class="pos-label">æµ®åŠ¨ç›ˆäº</div><div class="pos-value" id="pos-pnl">--</div></div>
    </div>
    
    <div class="trade-section">
      <div class="trade-btns">
        <button class="btn-buy" onclick="showBuyModal()">ä¹°å…¥</button>
        <button class="btn-sell" onclick="showSellModal()">å–å‡º</button>
      </div>
    </div>
    
    <div class="game-footer safe-bottom">
      <div class="day-progress">
        <div class="day-counter" id="day-counter">ç¬¬0å¤©/5å¤©</div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
      </div>
      <button class="next-day-btn" onclick="nextDay()">ä¸‹ä¸€å¤© â–¶</button>
    </div>
  </div>
  
  <!-- æ•™å­¦å¼¹çª— -->
  <div id="teaching-modal" class="modal">
    <div class="modal-content">
      <div class="modal-title" id="modal-title">ğŸ“š æ•™å­¦</div>
      <div class="modal-body" id="modal-body"></div>
      <button class="btn-primary" id="teaching-btn" onclick="closeModal()">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>
  
  <!-- èµ„é‡‘é€‰æ‹©å¼¹çª— -->
  <div id="capital-modal" class="capital-modal">
    <div class="capital-overlay" onclick="hideCapitalModal()"></div>
    <div class="capital-card">
      <div class="capital-title">ğŸ’° é€‰æ‹©åˆå§‹èµ„é‡‘</div>
      <div class="capital-subtitle" id="capital-level-name">ç¬¬1å…³ï¼šè®¤è¯†å¸‚åœºåŸºç¡€</div>
      <div class="capital-grid" id="capital-grid"></div>
      <div class="capital-actions">
        <button class="btn-secondary" onclick="hideCapitalModal()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="confirmCapital()">å¼€å§‹é—¯å…³ ğŸš€</button>
      </div>
    </div>
  </div>
  
  <!-- ç»“ç®—ç•Œé¢ -->
  <div id="report-screen" class="screen report-screen">
    <div class="safe-top"></div>
    <div class="report-title" id="report-title">ğŸ‰ æ­å–œé€šå…³</div>
    <div class="report-card">
      <div class="grade-badge" id="grade-badge">A</div>
      <div class="report-stats">
        <div class="stat-item"><div class="stat-value" id="report-profit">+5.2%</div><div class="stat-label">æ”¶ç›Šç‡</div></div>
        <div class="stat-item"><div class="stat-value" id="report-trades">3</div><div class="stat-label">äº¤æ˜“æ¬¡æ•°</div></div>
        <div class="stat-item"><div class="stat-value" id="report-win">66%</div><div class="stat-label">èƒœç‡</div></div>
        <div class="stat-item"><div class="stat-value" id="report-score">85</div><div class="stat-label">ç»¼åˆè¯„åˆ†</div></div>
      </div>
    </div>
    <div class="report-actions">
      <button class="btn-primary" onclick="nextLevel()">ä¸‹ä¸€å…³ â–¶</button>
      <button class="btn-secondary" onclick="backToMenu()">è¿”å›èœå•</button>
    </div>
    <div class="safe-bottom"></div>
  </div>
  
  <!-- ä¹°å…¥å¼¹çª— -->
  <div id="buy-modal" class="trade-modal">
    <div class="trade-overlay" onclick="closeTradeModal('buy')"></div>
    <div class="trade-card safe-bottom">
      <div class="trade-header">
        <div class="trade-title buy">ğŸ“ˆ ä¹°å…¥</div>
        <button class="trade-close" onclick="closeTradeModal('buy')">Ã—</button>
      </div>
      <div class="trade-price-section">
        <div class="trade-price-label">å½“å‰ä»·æ ¼</div>
        <div class="trade-price-value up" id="buy-price">Â¥250.00</div>
      </div>
      <div class="trade-info-row">
        <span class="label">å¯ç”¨èµ„é‡‘</span>
        <span class="value" id="buy-cash">Â¥100,000</span>
      </div>
      <div class="trade-info-row">
        <span class="label">æœ€å¤§å¯ä¹°</span>
        <span class="value" id="buy-max-qty">400è‚¡</span>
      </div>
      <div class="qty-section">
        <div class="qty-label">ä¹°å…¥æ•°é‡ï¼ˆ100è‚¡èµ·ï¼‰</div>
        <div class="qty-input-row">
          <button class="qty-btn" onclick="adjustQty('buy', -100)">-</button>
          <input type="number" class="qty-input" id="buy-shares" value="100" step="100" min="100" oninput="updateTradeSummary('buy')">
          <button class="qty-btn" onclick="adjustQty('buy', 100)">+</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="qty-btn" style="flex:1" onclick="setTradeQty('buy', 100)">1æ‰‹</button>
          <button class="qty-btn" style="flex:1" onclick="setTradeQty('buy', 500)">5æ‰‹</button>
          <button class="qty-btn" style="flex:1" onclick="setTradeQty('buy', 1000)">10æ‰‹</button>
          <button class="qty-btn" style="flex:1" onclick="setTradeQtyMax('buy')">å…¨ä»“</button>
        </div>
      </div>
      <div class="trade-summary">
        <div class="trade-summary-row">
          <span class="label">é¢„ä¼°é‡‘é¢</span>
          <span class="value" id="buy-amount">Â¥25,000</span>
        </div>
        <div class="trade-summary-row">
          <span class="label">æ‰‹ç»­è´¹</span>
          <span class="value" id="buy-fee">Â¥7.50</span>
        </div>
        <div class="trade-summary-row" style="border-top:1px solid var(--bg-4);padding-top:10px;margin-top:6px;">
          <span class="label">åˆè®¡</span>
          <span class="value" id="buy-total" style="font-weight:700;color:var(--up);">Â¥25,007.50</span>
        </div>
      </div>
      <button class="trade-submit buy" id="buy-submit" onclick="executeBuy()">ç¡®è®¤ä¹°å…¥</button>
    </div>
  </div>
  
  <!-- å–å‡ºå¼¹çª— -->
  <div id="sell-modal" class="trade-modal">
    <div class="trade-overlay" onclick="closeTradeModal('sell')"></div>
    <div class="trade-card safe-bottom">
      <div class="trade-header">
        <div class="trade-title sell">ğŸ“‰ å–å‡º</div>
        <button class="trade-close" onclick="closeTradeModal('sell')">Ã—</button>
      </div>
      <div class="trade-price-section">
        <div class="trade-price-label">å½“å‰ä»·æ ¼</div>
        <div class="trade-price-value down" id="sell-price">Â¥250.00</div>
      </div>
      <div class="trade-info-row">
        <span class="label">æŒä»“æ•°é‡</span>
        <span class="value" id="sell-holding">0è‚¡</span>
      </div>
      <div class="trade-info-row">
        <span class="label">æŒä»“æˆæœ¬</span>
        <span class="value" id="sell-cost">--</span>
      </div>
      <div class="qty-section">
        <div class="qty-label">å–å‡ºæ•°é‡ï¼ˆ100è‚¡èµ·ï¼‰</div>
        <div class="qty-input-row">
          <button class="qty-btn" onclick="adjustQty('sell', -100)">-</button>
          <input type="number" class="qty-input" id="sell-shares" value="100" step="100" min="100" oninput="updateTradeSummary('sell')">
          <button class="qty-btn" onclick="adjustQty('sell', 100)">+</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="qty-btn" style="flex:1" onclick="setTradeQty('sell', 100)">1æ‰‹</button>
          <button class="qty-btn" style="flex:1" onclick="setTradeQty('sell', 500)">5æ‰‹</button>
          <button class="qty-btn" style="flex:1" onclick="setTradeQty('sell', 1000)">10æ‰‹</button>
          <button class="qty-btn" style="flex:1" onclick="setTradeQtyMax('sell')">æ¸…ä»“</button>
        </div>
      </div>
      <div class="trade-summary">
        <div class="trade-summary-row">
          <span class="label">é¢„ä¼°é‡‘é¢</span>
          <span class="value" id="sell-amount">Â¥25,000</span>
        </div>
        <div class="trade-summary-row">
          <span class="label">æ‰‹ç»­è´¹</span>
          <span class="value" id="sell-fee">Â¥32.50</span>
        </div>
        <div class="trade-summary-row" style="border-top:1px solid var(--bg-4);padding-top:10px;margin-top:6px;">
          <span class="label">é¢„ä¼°ç›ˆäº</span>
          <span class="value" id="sell-profit" style="color:var(--up);">+Â¥1,000</span>
        </div>
      </div>
      <button class="trade-submit sell" id="sell-submit" onclick="executeSell()">ç¡®è®¤å–å‡º</button>
    </div>
  </div>
  
  <script>
    // ===== æ¸¸æˆçŠ¶æ€ =====
    let currentLevel = 0, dayIndex = 0, cash = 100000, initialCash = 100000;
    let shares = 0, avgCost = 0, tradeCount = 0, winCount = 0;
    let priceHistory = [], indicators = {};
    let unlockedLevels = [true, false, false, false, false];
    let selectedCapital = 100000;  // é»˜è®¤10ä¸‡
    let pendingLevelIndex = null;  // å¾…å¼€å§‹çš„å…³å¡ç´¢å¼•
    
    // Canvas contexts
    let klineCtx, volCtx, macdCtx;
    let klineW, klineH, volW, volH, macdW, macdH;
    
    const LEVELS = [
      { 
        id: 1, title: 'è®¤è¯†å¸‚åœºåŸºç¡€', subtitle: 'å­¦ä¹ Kçº¿å›¾çš„è¯­è¨€', days: 5, profit: 0.05, price: 250, features: [],
        lessons: [
          { title: 'ğŸ“š è‚¡ç¥¨æ˜¯ä»€ä¹ˆï¼Ÿ', content: '<p>ä¹°è‚¡ç¥¨å°±æ˜¯æˆä¸ºå…¬å¸çš„<b>"è‚¡ä¸œ"</b></p><p>å¾·æ˜åˆ©(001309)æ˜¯<span class="hl">å­˜å‚¨èŠ¯ç‰‡</span>é¾™å¤´ä¼ä¸š</p><div class="teach-box"><p>âœ… <b>é‡ç‚¹ï¼š</b></p><ul><li>è‚¡ä»· = å¸‚åœºå¯¹å…¬å¸ä»·å€¼çš„çœ‹æ³•</li><li>ç›®æ ‡ï¼šä½ä¹°é«˜å–</li></ul></div>' },
          { title: 'ğŸ“Š Kçº¿å›¾åŸºç¡€', content: '<p><b>çº¢è‰²é˜³çº¿</b> = æ”¶ç›˜ > å¼€ç›˜ = ä¸Šæ¶¨</p><p><b>ç»¿è‰²é˜´çº¿</b> = æ”¶ç›˜ < å¼€ç›˜ = ä¸‹è·Œ</p><div class="teach-box"><p>ğŸ“ˆ <b>å®ä½“</b>ï¼šå¼€ç›˜åˆ°æ”¶ç›˜çš„æ³¢åŠ¨</p><p>ğŸ“ <b>å½±çº¿</b>ï¼šç›˜ä¸­æ³¢åŠ¨èŒƒå›´</p></div>' }
        ],
        quiz: [
          { question: 'å¾·æ˜åˆ©ä»Šå¤©å¼€ç›˜250å…ƒï¼Œæ”¶ç›˜255å…ƒï¼Œè¿™æ ¹Kçº¿æ˜¯ä»€ä¹ˆé¢œè‰²ï¼Ÿ', options: ['çº¢è‰²é˜³çº¿', 'ç»¿è‰²é˜´çº¿', 'åå­—æ˜Ÿ'], answer: 0, explanation: 'å› ä¸ºæ”¶ç›˜ä»· 255å…ƒ > å¼€ç›˜ä»· 250å…ƒï¼Œè‚¡ä»·ä¸Šæ¶¨ï¼Œæ‰€ä»¥æ˜¯çº¢è‰²é˜³çº¿ã€‚' },
          { question: 'å½±çº¿å¾ˆé•¿çš„Kçº¿è¯´æ˜ä»€ä¹ˆï¼Ÿ', options: ['ç›˜ä¸­æ³¢åŠ¨å¾ˆå¤§', 'æˆäº¤é‡å¾ˆå¤§', 'æ²¡æœ‰ä»»ä½•æ„ä¹‰'], answer: 0, explanation: 'é•¿å½±çº¿æ„å‘³ç€ç›˜ä¸­ä»·æ ¼æ³¢åŠ¨äº†å¾ˆå¤šï¼Œè¯´æ˜å¤šç©ºåŠ›é‡åœ¨äº‰å¤ºã€‚' }
        ]
      },
      { 
        id: 2, title: 'æˆäº¤é‡åˆ†æ', subtitle: 'å¸‚åœºçš„"å¿ƒè·³"', days: 8, profit: 0.08, price: 240, features: ['volume'],
        lessons: [
          { title: 'ğŸ«€ æˆäº¤é‡æ˜¯å¸‚åœºçš„"å¿ƒè·³"', content: '<p><b>æˆäº¤é‡</b> = è‚¡ç¥¨æ¢æ‰‹çš„æ•°é‡ï¼Œåæ˜ å¸‚åœºæ´»è·ƒç¨‹åº¦</p><div class="teach-box"><p>ğŸ’¡ <b>å…³é”®ï¼š</b></p><ul><li>é‡è¶Šå¤§ = å…³æ³¨åº¦è¶Šé«˜</li><li>é‡æ”¾å¤§ = èµ„é‡‘åœ¨è¿›åœºæˆ–å‡ºåœº</li></ul></div>' },
          { title: 'ğŸ“Š é‡ä»·å…³ç³»4ç§æ¨¡å¼', content: '<div class="teach-box"><p>ğŸ”¥ <b>é‡å¢ä»·æ¶¨</b> = å¥åº·ï¼Œå¯è·Ÿè¿›</p><p>ğŸ’€ <b>é‡å¢ä»·è·Œ</b> = å±é™©ï¼Œè€ƒè™‘å–å‡º</p><p>âš ï¸ <b>é‡ç¼©ä»·æ¶¨</b> = è­¦æƒ•ï¼Œä¸è¿½é«˜</p><p>ğŸ¤” <b>é‡ç¼©ä»·è·Œ</b> = è§‚æœ›ï¼Œç­‰æ–¹å‘</p></div>' }
        ],
        quiz: [
          { question: 'ä»Šå¤©æ”¾é‡ä¸Šæ¶¨3%ï¼Œè¯´æ˜ä»€ä¹ˆï¼Ÿ', options: ['èµ„é‡‘ç§¯æä¹°å…¥', 'ä¸Šæ¶¨å³å°†ç»“æŸ', 'æ²¡æœ‰æ„ä¹‰'], answer: 0, explanation: 'æ”¾é‡ä¸Šæ¶¨æ˜¯æœ€å¥åº·çš„ä¸Šæ¶¨æ¨¡å¼ï¼Œè¯´æ˜æœ‰çœŸé‡‘ç™½é“¶æ¨åŠ¨ã€‚' },
          { question: 'è‚¡ä»·ä¸‹è·Œä½†æˆäº¤é‡æ”¾å¤§ï¼Œåº”è¯¥ï¼Ÿ', options: ['æŠ„åº•ä¹°å…¥', 'è§‚æœ›ä¸åŠ¨', 'è€ƒè™‘å–å‡º'], answer: 2, explanation: 'é‡å¢ä»·è·Œè¯´æ˜èµ„é‡‘åœ¨å‡ºé€ƒï¼Œæ˜¯å±é™©ä¿¡å·ï¼Œåº”è€ƒè™‘å–å‡ºã€‚' }
        ]
      },
      { 
        id: 3, title: 'å‡çº¿ç³»ç»Ÿ', subtitle: '5æ—¥ã€10æ—¥ã€20æ—¥çº¿', days: 10, profit: 0.10, price: 230, features: ['ma5', 'ma10', 'ma20'],
        lessons: [
          { title: 'ğŸ“ å‡çº¿æ˜¯"å¹³å‡æˆæœ¬"', content: '<p><b>å‡çº¿(MA)</b> = è¿‡å»Nå¤©æ”¶ç›˜ä»·çš„å¹³å‡å€¼</p><div class="teach-box"><p>ğŸŸ¡ <b>MA5</b> = æœ€è¿‘5å¤©ä¹°å…¥è€…å¹³å‡æˆæœ¬</p><p>ğŸ”µ <b>MA10</b> = æœ€è¿‘10å¤©ä¹°å…¥è€…å¹³å‡æˆæœ¬</p><p>ğŸ©· <b>MA20</b> = æœ€è¿‘20å¤©ä¹°å…¥è€…å¹³å‡æˆæœ¬</p></div>' },
          { title: 'ğŸ“ˆ å¤šç©ºæ’åˆ—', content: '<div class="teach-box"><p>âœ… <b>å¤šå¤´æ’åˆ—</b>ï¼šè‚¡ä»·>MA5>MA10>MA20ï¼Œä¸Šæ¶¨è¶‹åŠ¿</p><p>ğŸ›‘ <b>ç©ºå¤´æ’åˆ—</b>ï¼šè‚¡ä»·<MA5<MA10<MA20ï¼Œä¸‹è·Œè¶‹åŠ¿</p></div>' }
        ],
        quiz: [
          { question: 'MA5>MA10>MA20è¯´æ˜ä»€ä¹ˆï¼Ÿ', options: ['å¤šå¤´æ’åˆ—ï¼Œè¶‹åŠ¿å‘ä¸Š', 'ç©ºå¤´æ’åˆ—ï¼Œè¶‹åŠ¿å‘ä¸‹', 'æ²¡æœ‰æ„ä¹‰'], answer: 0, explanation: 'çŸ­æœŸæˆæœ¬>ä¸­æœŸæˆæœ¬>é•¿æœŸæˆæœ¬ï¼Œè¯´æ˜å¸‚åœºå¤„äºä¸Šæ¶¨è¶‹åŠ¿ã€‚' }
        ]
      },
      { 
        id: 4, title: 'æ”¯æ’‘ä¸å‹åŠ›', subtitle: 'åœ°æ¿ä¸å¤©èŠ±æ¿', days: 12, profit: 0.12, price: 225, features: ['ma30'],
        lessons: [
          { title: 'ğŸ—ï¸ æ”¯æ’‘ä¸å‹åŠ›ä½', content: '<p><b>æ”¯æ’‘ä½</b> = è‚¡ä»·éš¾ä»¥è·Œç ´çš„ä»·ä½ï¼Œåƒ"åœ°æ¿"</p><p><b>å‹åŠ›ä½</b> = è‚¡ä»·éš¾ä»¥çªç ´çš„ä»·ä½ï¼Œåƒ"å¤©èŠ±æ¿"</p><div class="teach-box"><p>ğŸ’¡ æ”¯æ’‘ä½é™„è¿‘ä¹°å…¥ï¼Œé£é™©å°</p><p>ğŸ’¡ å‹åŠ›ä½é™„è¿‘å–å‡ºï¼Œæˆ–ç­‰çªç ´</p></div>' }
        ],
        quiz: [
          { question: 'è‚¡ä»·æ”¾é‡çªç ´å‹åŠ›ä½ï¼Œåº”è¯¥ï¼Ÿ', options: ['å¯ä»¥è·Ÿè¿›ä¹°å…¥', 'ç«‹å³å–å‡º', 'æ²¡æœ‰å‚è€ƒæ„ä¹‰'], answer: 0, explanation: 'æ”¾é‡çªç ´å‹åŠ›ä½è¯´æ˜å¤šæ–¹åŠ›é‡å¼ºå¤§ï¼Œå¯ä»¥è€ƒè™‘ä¹°å…¥ã€‚' }
        ]
      },
      { 
        id: 5, title: 'å®æˆ˜äº¤æ˜“ç³»ç»Ÿ', subtitle: 'ç»¼åˆè¿ç”¨', days: 15, profit: 0.15, price: 220, features: ['macd'],
        lessons: [
          { title: 'ğŸ”§ äº¤æ˜“ç³»ç»Ÿ6æ­¥éª¤', content: '<div class="teach-box"><p>1ï¸âƒ£ åˆ†æè¶‹åŠ¿ â†’ 2ï¸âƒ£ æ‰¾å…¥åœºç‚¹ â†’ 3ï¸âƒ£ å®šä»“ä½</p><p>4ï¸âƒ£ è®¾æ­¢æŸ â†’ 5ï¸âƒ£ å®šæ­¢ç›ˆ â†’ 6ï¸âƒ£ æ‰§è¡Œå¤ç›˜</p></div><p>âš ï¸ <b>çºªå¾‹æ˜¯ç›ˆåˆ©çš„å…³é”®ï¼</b></p>' },
          { title: 'ğŸ“Š MACDæŒ‡æ ‡', content: '<p><b>MACD</b> = è¶‹åŠ¿è·Ÿè¸ªæŒ‡æ ‡</p><div class="teach-box"><p>âœ¨ <b>é‡‘å‰</b>ï¼šDIFä¸Šç©¿DEAï¼Œä¹°å…¥ä¿¡å·</p><p>âŒ <b>æ­»å‰</b>ï¼šDIFä¸‹ç©¿DEAï¼Œå–å‡ºä¿¡å·</p></div>' }
        ],
        quiz: [
          { question: 'MACDé‡‘å‰+æ”¾é‡ï¼Œæœ€ä½³æ“ä½œï¼Ÿ', options: ['åˆ†æ‰¹ä¹°å…¥', 'å…¨ä»“å–å‡º', 'ç»§ç»­è§‚æœ›'], answer: 0, explanation: 'MACDé‡‘å‰+æ”¾é‡æ˜¯åŒé‡ç¡®è®¤çš„ä¹°å…¥ä¿¡å·ï¼Œåˆ†æ‰¹ä¹°å…¥å¯æ§åˆ¶é£é™©ã€‚' }
        ]
      }
    ];
    
    // æ•™å­¦ç³»ç»ŸçŠ¶æ€
    let currentLessonIdx = 0;
    let currentQuizIdx = 0;
    let teachingComplete = false;
    
    function init() {
      loadProgress();
      renderLevelGrid();
    }
    
    function loadProgress() {
      const saved = localStorage.getItem('stockgame_v4');
      if (saved) unlockedLevels = JSON.parse(saved).unlocked || unlockedLevels;
    }
    
    function saveProgress() {
      localStorage.setItem('stockgame_v4', JSON.stringify({ unlocked: unlockedLevels }));
    }
    
    function renderLevelGrid() {
      document.getElementById('completed-levels').textContent = unlockedLevels.filter((v, i) => i > 0 && v).length;
      document.getElementById('level-grid').innerHTML = LEVELS.map((level, i) => `
        <div class="level-card ${unlockedLevels[i] ? '' : 'locked'} ${unlockedLevels[i+1] ? 'completed' : ''}" onclick="showCapitalModal(${i})">
          <div class="level-header">
            <div class="level-num">${level.id}</div>
            <div class="level-info"><h3>${level.title}</h3><p>${level.subtitle}</p></div>
          </div>
          <div class="level-meta"><span>${level.days}å¤©</span><span class="level-target">ç›®æ ‡+${(level.profit * 100).toFixed(0)}%</span><span>è‡ªé€‰èµ„é‡‘</span></div>
        </div>
      `).join('');
    }
    
    // ===== èµ„é‡‘é€‰æ‹©å¼¹çª— =====
    function showCapitalModal(levelIndex) {
      if (!unlockedLevels[levelIndex]) { showToast('ğŸ”’ æœªè§£é”', 'error'); return; }
      
      pendingLevelIndex = levelIndex;
      const level = LEVELS[levelIndex];
      document.getElementById('capital-level-name').textContent = `ç¬¬${level.id}å…³ï¼š${level.title}`;
      
      // æ¸²æŸ“èµ„é‡‘é€‰é¡¹ 10ä¸‡-100ä¸‡
      const amounts = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
      document.getElementById('capital-grid').innerHTML = amounts.map(amt => {
        const wan = amt;
        const actualAmt = amt * 10000;
        const selected = actualAmt === selectedCapital ? 'selected' : '';
        return `<div class="capital-option ${selected}" onclick="selectCapital(${actualAmt}, this)">
          <div class="capital-amount">${wan}</div>
          <div class="capital-unit">ä¸‡å…ƒ</div>
        </div>`;
      }).join('');
      
      document.getElementById('capital-modal').classList.add('show');
    }
    
    function hideCapitalModal() {
      document.getElementById('capital-modal').classList.remove('show');
      pendingLevelIndex = null;
    }
    
    function selectCapital(amt, el) {
      selectedCapital = amt;
      document.querySelectorAll('.capital-option').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
    }
    
    function confirmCapital() {
      if (pendingLevelIndex !== null) {
        const levelIndex = pendingLevelIndex;
        hideCapitalModal();
        startLevel(levelIndex);
      }
    }
    
    function startLevel(levelIndex) {
      if (!unlockedLevels[levelIndex]) { showToast('ğŸ”’ æœªè§£é”', 'error'); return; }
      
      currentLevel = levelIndex;
      const level = LEVELS[levelIndex];
      dayIndex = 0; 
      cash = selectedCapital;  // ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„èµ„é‡‘
      initialCash = selectedCapital;
      shares = 0; avgCost = 0; tradeCount = 0; winCount = 0;
      
      generatePriceData(level);
      
      document.getElementById('level-badge').textContent = `ç¬¬${level.id}å…³`;
      showScreen('game');
      
      // åˆå§‹åŒ–Canvas
      initCharts();
      
      // è®¡ç®—æŒ‡æ ‡
      calculateIndicators();
      
      updateUI();
      
      // å¯åŠ¨æ•™å­¦
      setTimeout(() => startTeaching(levelIndex), 500);
    }
    
    function initCharts() {
      const dpr = window.devicePixelRatio || 1;
      
      // Kçº¿å›¾
      const klineCanvas = document.getElementById('kline-chart');
      klineW = klineCanvas.offsetWidth;
      klineH = klineCanvas.offsetHeight;
      klineCanvas.width = klineW * dpr;
      klineCanvas.height = klineH * dpr;
      klineCtx = klineCanvas.getContext('2d');
      klineCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      
      // æˆäº¤é‡å›¾
      const volCanvas = document.getElementById('vol-chart');
      volW = volCanvas.offsetWidth;
      volH = volCanvas.offsetHeight;
      volCanvas.width = volW * dpr;
      volCanvas.height = volH * dpr;
      volCtx = volCanvas.getContext('2d');
      volCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      
      // MACDå›¾
      const macdCanvas = document.getElementById('macd-chart');
      macdW = macdCanvas.offsetWidth;
      macdH = macdCanvas.offsetHeight;
      macdCanvas.width = macdW * dpr;
      macdCanvas.height = macdH * dpr;
      macdCtx = macdCanvas.getContext('2d');
      macdCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    
    function generatePriceData(level) {
      priceHistory = [];
      let price = level.price;
      
      // ç»Ÿä¸€çš„åŸºå‡†æˆäº¤é‡
      const baseVol = 500000;
      
      // å†å²æ•°æ®ï¼ˆ25å¤©ï¼‰
      for (let i = 0; i < 25; i++) {
        const prevClose = price;
        const change = (Math.random() - 0.48) * 0.025;
        const close = prevClose * (1 + change);
        
        let open;
        if (change >= 0) {
          open = close * (1 - Math.random() * 0.012);
        } else {
          open = close * (1 + Math.random() * 0.012);
        }
        
        const high = Math.max(open, close) * (1 + Math.random() * 0.008);
        const low = Math.min(open, close) * (1 - Math.random() * 0.008);
        
        // æˆäº¤é‡ï¼šéšæœºç”Ÿæˆï¼ŒèŒƒå›´åœ¨0.6-1.5å€åŸºå‡†é‡
        const volRatio = 0.6 + Math.random() * 0.9;
        const volume = baseVol * volRatio;
        
        priceHistory.push({
          open, high, low, close, volume,
          change,
          isHistory: true,
          volRatio: volRatio
        });
        
        price = close;
      }
      
      // äº¤æ˜“æ—¥æ•°æ® - é‡ä»·å…³ç³»æ˜ç¡®
      const trends = ['up', 'up', 'down', 'up', 'up', 'down', 'up', 'down', 'up', 'up', 'up', 'down', 'up', 'up', 'down'];
      let dayPrice = priceHistory[priceHistory.length - 1].close;
      
      for (let d = 0; d < level.days; d++) {
        const trend = trends[d % trends.length];
        const strength = 0.015 + Math.random() * 0.018;
        let change = trend === 'up' ? strength : -strength;
        
        const prevClose = dayPrice;
        const close = prevClose * (1 + change);
        
        let open;
        if (change >= 0) {
          open = close * (1 - Math.random() * 0.01);
        } else {
          open = close * (1 + Math.random() * 0.01);
        }
        
        const high = Math.max(open, close) * (1 + Math.random() * 0.006);
        const low = Math.min(open, close) * (1 - Math.random() * 0.006);
        
        // æˆäº¤é‡ä¸æ¶¨è·Œå¹…åº¦å¯¹åº”ï¼šå¤§æ¶¨å¤§è·Œæ”¾é‡ï¼Œå°æ¶¨å°è·Œç¼©é‡
        let volRatio;
        if (Math.abs(change) > 0.025) {
          volRatio = 1.5 + Math.random() * 0.5;  // å¤§å¹…æ³¢åŠ¨ï¼šæ”¾é‡ 1.5-2.0
        } else if (Math.abs(change) > 0.018) {
          volRatio = 1.0 + Math.random() * 0.3;  // ä¸­ç­‰æ³¢åŠ¨ï¼šæ­£å¸¸ 1.0-1.3
        } else {
          volRatio = 0.5 + Math.random() * 0.3;  // å°å¹…æ³¢åŠ¨ï¼šç¼©é‡ 0.5-0.8
        }
        const volume = baseVol * volRatio;
        
        priceHistory.push({
          open, high, low, close, volume,
          change,
          isHistory: false,
          tradingDay: d + 1,
          volRatio: volRatio
        });
        
        dayPrice = close;
      }
    }
    
    function calculateIndicators() {
      // MA5, MA10, MA20, MA30
      indicators.ma5 = [], indicators.ma10 = [], indicators.ma20 = [], indicators.ma30 = [];
      indicators.volMa5 = [], indicators.volMa10 = [];
      
      for (let i = 0; i < priceHistory.length; i++) {
        // MA5
        if (i >= 4) {
          let sum = 0;
          for (let j = 0; j < 5; j++) sum += priceHistory[i - j].close;
          indicators.ma5[i] = sum / 5;
        }
        // MA10
        if (i >= 9) {
          let sum = 0;
          for (let j = 0; j < 10; j++) sum += priceHistory[i - j].close;
          indicators.ma10[i] = sum / 10;
        }
        // MA20
        if (i >= 19) {
          let sum = 0;
          for (let j = 0; j < 20; j++) sum += priceHistory[i - j].close;
          indicators.ma20[i] = sum / 20;
        }
        // MA30
        if (i >= 29) {
          let sum = 0;
          for (let j = 0; j < 30; j++) sum += priceHistory[i - j].close;
          indicators.ma30[i] = sum / 30;
        }
        // VolMA5
        if (i >= 4) {
          let sum = 0;
          for (let j = 0; j < 5; j++) sum += priceHistory[i - j].volume;
          indicators.volMa5[i] = sum / 5;
        }
        // VolMA10
        if (i >= 9) {
          let sum = 0;
          for (let j = 0; j < 10; j++) sum += priceHistory[i - j].volume;
          indicators.volMa10[i] = sum / 10;
        }
      }
      
      // MACD
      indicators.dif = [], indicators.dea = [], indicators.macd = [];
      const ema12 = [], ema26 = [];
      for (let i = 0; i < priceHistory.length; i++) {
        const c = priceHistory[i].close;
        if (i === 0) { ema12[i] = c; ema26[i] = c; }
        else {
          ema12[i] = c * (2 / 13) + ema12[i - 1] * (11 / 13);
          ema26[i] = c * (2 / 27) + ema26[i - 1] * (25 / 27);
        }
        indicators.dif[i] = ema12[i] - ema26[i];
        if (i === 0) indicators.dea[i] = indicators.dif[i];
        else indicators.dea[i] = indicators.dif[i] * (2 / 10) + indicators.dea[i - 1] * (8 / 10);
        indicators.macd[i] = (indicators.dif[i] - indicators.dea[i]) * 2;
      }
    }
    
    function drawCharts() {
      const level = LEVELS[currentLevel];
      // å†å²æ•°æ®25æ¡ + å·²è¿‡å»çš„äº¤æ˜“æ—¥
      const historyCount = 25;
      // dayIndex=0æ—¶æ˜¾ç¤ºå†å²25æ¡ï¼ŒdayIndex=1æ—¶æ˜¾ç¤ºå†å²25æ¡+ç¬¬1ä¸ªäº¤æ˜“æ—¥
      const visibleCount = Math.min(priceHistory.length, historyCount + dayIndex);
      // ä»å¼€å¤´å¼€å§‹å–
      const data = priceHistory.slice(0, visibleCount);
      
      // é˜²æ­¢ç©ºæ•°æ®
      if (!data || data.length === 0) return;
      
      const pad = { left: 4, right: 50, top: 24, bottom: 8 };
      const cw = klineW - pad.left - pad.right;
      const ch = klineH - pad.top - pad.bottom;
      const candleW = Math.max(2, Math.min(8, Math.floor(cw / data.length * 0.7)));
      const gap = Math.floor((cw - candleW * data.length) / data.length);
      const step = candleW + gap;
      const toX = (i) => pad.left + gap / 2 + i * step;
      
      // ä»·æ ¼èŒƒå›´ï¼ˆåŸºäºæ‰€æœ‰å¯è§æ•°æ®ï¼‰
      const prices = data.flatMap(d => [d.high, d.low]);
      data.forEach((d, i) => {
        if (indicators.ma5[i]) prices.push(indicators.ma5[i]);
        if (indicators.ma10[i]) prices.push(indicators.ma10[i]);
        if (indicators.ma20[i]) prices.push(indicators.ma20[i]);
      });
      const minP = Math.min(...prices) * 0.998;
      const maxP = Math.max(...prices) * 1.002;
      const range = maxP - minP || 1;
      const toY = p => pad.top + ch * (1 - (p - minP) / range);
      
      // ===== Kçº¿å›¾ =====
      klineCtx.clearRect(0, 0, klineW, klineH);
      klineCtx.fillStyle = '#0c1018';
      klineCtx.fillRect(0, 0, klineW, klineH);
      
      // ç½‘æ ¼
      klineCtx.strokeStyle = 'rgba(255,255,255,0.03)';
      for (let i = 0; i <= 4; i++) {
        const y = pad.top + i * ch / 4;
        klineCtx.beginPath(); klineCtx.moveTo(pad.left, y); klineCtx.lineTo(klineW - pad.right, y); klineCtx.stroke();
        const price = maxP - i * range / 4;
        klineCtx.fillStyle = '#4b5563'; klineCtx.font = '9px monospace'; klineCtx.textAlign = 'right';
        klineCtx.fillText(price.toFixed(2), klineW - 2, y + 3);
      }
      
      // Kçº¿
      data.forEach((d, i) => {
        const x = toX(i), cx = x + candleW / 2;
        const isUp = d.close >= d.open;
        const color = isUp ? '#ef4444' : '#22c55e';
        
        // å½±çº¿
        klineCtx.strokeStyle = color; klineCtx.lineWidth = 1;
        klineCtx.beginPath(); klineCtx.moveTo(cx, toY(d.high)); klineCtx.lineTo(cx, toY(d.low)); klineCtx.stroke();
        
        // å®ä½“
        const bt = toY(Math.max(d.open, d.close)), bb = toY(Math.min(d.open, d.close));
        const bh = Math.max(1, bb - bt);
        klineCtx.fillStyle = color;
        klineCtx.fillRect(x, bt, candleW, bh);
        
        // å½“æ—¥é«˜äº®ï¼ˆtradingDayä»1å¼€å§‹ï¼ŒdayIndexä¹Ÿæ˜¯ä»1å¼€å§‹è¡¨ç¤ºç¬¬1ä¸ªäº¤æ˜“æ—¥ï¼‰
        if (!d.isHistory && d.tradingDay === dayIndex) {
          klineCtx.strokeStyle = 'rgba(96,165,250,0.7)'; klineCtx.lineWidth = 1.5;
          klineCtx.strokeRect(x - 1, toY(d.high) - 2, candleW + 2, toY(d.low) - toY(d.high) + 4);
        }
      });
      
      // MAçº¿
      const maStyles = [
        { key: 'ma5', color: '#eab308', label: 'MA5' },
        { key: 'ma10', color: '#3b82f6', label: 'MA10' },
        { key: 'ma20', color: '#ec4899', label: 'MA20' },
      ];
      
      let lx = pad.left + 4;
      maStyles.forEach(ma => {
        if (!indicators[ma.key]) return;
        if (ma.key !== 'ma5' && !level.features.includes(ma.key)) return;
        
        klineCtx.beginPath(); klineCtx.strokeStyle = ma.color; klineCtx.lineWidth = 1;
        let started = false;
        for (let i = 0; i < data.length; i++) {
          const v = indicators[ma.key][i];
          if (v == null) continue;
          const px = toX(i) + candleW / 2, py = toY(v);
          if (!started) { klineCtx.moveTo(px, py); started = true; }
          else klineCtx.lineTo(px, py);
        }
        klineCtx.stroke();
        
        // å›¾ä¾‹
        klineCtx.fillStyle = ma.color; klineCtx.font = '9px monospace'; klineCtx.textAlign = 'left';
        const lastV = indicators[ma.key][data.length - 1];
        klineCtx.fillText(`${ma.label}:${lastV ? lastV.toFixed(2) : '--'}`, lx, 12);
        lx += 70;
      });
      
      // OHLCä¿¡æ¯
      const lastD = data[data.length - 1];
      klineCtx.fillStyle = '#8899aa'; klineCtx.font = '9px sans-serif'; klineCtx.textAlign = 'left';
      klineCtx.fillText(`å¼€${lastD.open.toFixed(2)} é«˜${lastD.high.toFixed(2)} ä½${lastD.low.toFixed(2)} æ”¶${lastD.close.toFixed(2)}`, pad.left + 4, klineH - 2);
      
      // ===== æˆäº¤é‡å›¾ =====
      volCtx.clearRect(0, 0, volW, volH);
      volCtx.fillStyle = '#0c1018';
      volCtx.fillRect(0, 0, volW, volH);
      
      const maxVol = Math.max(...data.map(d => d.volume)) || 1;
      const vPad = { left: pad.left, right: pad.right, top: 4, bottom: 2 };
      const vArea = volH - vPad.top - vPad.bottom;
      
      // æˆäº¤é‡æŸ±
      data.forEach((d, i) => {
        const x = toX(i);
        const barH = Math.max(1, (d.volume / maxVol) * vArea);
        const isUp = d.close >= d.open;
        volCtx.fillStyle = isUp ? 'rgba(239,68,68,0.55)' : 'rgba(34,197,94,0.55)';
        volCtx.fillRect(x, volH - barH - vPad.bottom, candleW, barH);
      });
      
      // VolMAçº¿
      volCtx.fillStyle = '#6b7280'; volCtx.font = '9px monospace'; volCtx.textAlign = 'left';
      volCtx.fillText('æˆäº¤', 4, 10);
      
      if (indicators.volMa5) {
        volCtx.beginPath(); volCtx.strokeStyle = '#eab308'; volCtx.lineWidth = 1;
        let started = false;
        for (let i = 0; i < data.length; i++) {
          const v = indicators.volMa5[i];
          if (v == null) continue;
          const px = toX(i) + candleW / 2;
          const py = volH - vPad.bottom - (v / maxVol) * vArea;
          if (!started) { volCtx.moveTo(px, py); started = true; }
          else volCtx.lineTo(px, py);
        }
        volCtx.stroke();
      }
      
      // ===== MACDå›¾ =====
      macdCtx.clearRect(0, 0, macdW, macdH);
      macdCtx.fillStyle = '#0c1018';
      macdCtx.fillRect(0, 0, macdW, macdH);
      
      const mPad = { left: pad.left, right: pad.right, top: 4, bottom: 2 };
      const midY = macdH / 2;
      const macdVals = data.map((d, i) => indicators.macd[i]).filter(v => v != null);
      const maxM = Math.max(...macdVals.map(Math.abs), 0.01) * 1.1;
      const scaleM = (macdH - mPad.top - mPad.bottom) / 2;
      
      // é›¶è½´
      macdCtx.strokeStyle = 'rgba(255,255,255,0.05)';
      macdCtx.beginPath(); macdCtx.moveTo(mPad.left, midY); macdCtx.lineTo(macdW - mPad.right, midY); macdCtx.stroke();
      
      // MACDæŸ±
      data.forEach((d, i) => {
        const v = indicators.macd[i];
        if (v == null) return;
        const x = toX(i);
        const barH = Math.abs(v / maxM) * scaleM;
        macdCtx.fillStyle = v >= 0 ? '#ef4444' : '#22c55e';
        if (v >= 0) macdCtx.fillRect(x, midY - barH, candleW, barH);
        else macdCtx.fillRect(x, midY, candleW, barH);
      });
      
      // DIF/DEAçº¿
      macdCtx.beginPath(); macdCtx.strokeStyle = '#3b82f6'; macdCtx.lineWidth = 1;
      let started = false;
      for (let i = 0; i < data.length; i++) {
        const v = indicators.dif[i];
        if (v == null) continue;
        const px = toX(i) + candleW / 2;
        const py = midY - (v / maxM) * scaleM;
        if (!started) { macdCtx.moveTo(px, py); started = true; }
        else macdCtx.lineTo(px, py);
      }
      macdCtx.stroke();
      
      macdCtx.beginPath(); macdCtx.strokeStyle = '#eab308'; macdCtx.lineWidth = 1;
      started = false;
      for (let i = 0; i < data.length; i++) {
        const v = indicators.dea[i];
        if (v == null) continue;
        const px = toX(i) + candleW / 2;
        const py = midY - (v / maxM) * scaleM;
        if (!started) { macdCtx.moveTo(px, py); started = true; }
        else macdCtx.lineTo(px, py);
      }
      macdCtx.stroke();
      
      // å›¾ä¾‹
      macdCtx.fillStyle = '#6b7280'; macdCtx.font = '9px monospace'; macdCtx.textAlign = 'left';
      macdCtx.fillText('MACD', 4, 10);
    }
    
    // ===== äº¤æ˜“å¼¹çª— =====
    function showBuyModal() {
      const price = getCurrentPrice();
      document.getElementById('buy-price').textContent = 'Â¥' + price.toFixed(2);
      document.getElementById('buy-cash').textContent = 'Â¥' + cash.toFixed(0);
      const maxQty = Math.floor(cash / (price * 1.001));
      const maxQtyEl = document.getElementById('buy-max-qty');
      if (maxQtyEl) maxQtyEl.textContent = Math.floor(maxQty / 100) * 100 + 'è‚¡';
      document.getElementById('buy-shares').value = 100;
      updateTradeSummary('buy');
      document.getElementById('buy-modal').classList.add('show');
    }
    
    function showSellModal() {
      const price = getCurrentPrice();
      document.getElementById('sell-price').textContent = 'Â¥' + price.toFixed(2);
      document.getElementById('sell-holding').textContent = shares + 'è‚¡';
      document.getElementById('sell-cost').textContent = shares > 0 ? 'Â¥' + avgCost.toFixed(2) : '--';
      document.getElementById('sell-shares').value = Math.min(100, shares);
      updateTradeSummary('sell');
      document.getElementById('sell-modal').classList.add('show');
    }
    
    function closeTradeModal(type) {
      document.getElementById(type + '-modal').classList.remove('show');
    }
    
    function adjustQty(type, delta) {
      const input = document.getElementById(type + '-shares');
      let val = parseInt(input.value) || 100;
      val = Math.max(100, val + delta);
      input.value = val;
      updateTradeSummary(type);
    }
    
    function setTradeQty(type, qty) {
      document.getElementById(type + '-shares').value = qty;
      updateTradeSummary(type);
    }
    
    function setTradeQtyMax(type) {
      const price = getCurrentPrice();
      if (type === 'buy') {
        const maxQty = Math.floor(cash / (price * 1.001));
        const qty = maxQty - (maxQty % 100);
        document.getElementById('buy-shares').value = Math.max(100, qty);
      } else {
        document.getElementById('sell-shares').value = shares;
      }
      updateTradeSummary(type);
    }
    
    function updateTradeSummary(type) {
      const price = getCurrentPrice();
      const qty = parseInt(document.getElementById(type + '-shares').value) || 100;
      
      if (type === 'buy') {
        const amount = price * qty;
        const fee = Math.max(5, amount * 0.0003);
        const total = amount + fee;
        const canBuy = total <= cash;
        
        document.getElementById('buy-amount').textContent = 'Â¥' + amount.toFixed(0);
        document.getElementById('buy-fee').textContent = 'Â¥' + fee.toFixed(2);
        document.getElementById('buy-total').textContent = 'Â¥' + total.toFixed(0);
        document.getElementById('buy-submit').disabled = !canBuy || qty < 100;
      } else {
        const amount = price * qty;
        const commission = Math.max(5, amount * 0.0003);
        const tax = amount * 0.001;
        const fee = commission + tax;
        const revenue = amount - fee;
        const profit = shares > 0 ? (price - avgCost) * qty - fee : 0;
        
        document.getElementById('sell-amount').textContent = 'Â¥' + amount.toFixed(0);
        document.getElementById('sell-fee').textContent = 'Â¥' + fee.toFixed(2);
        const profitEl = document.getElementById('sell-profit');
        profitEl.textContent = (profit >= 0 ? '+' : '') + 'Â¥' + profit.toFixed(0);
        profitEl.style.color = profit >= 0 ? 'var(--up)' : 'var(--down)';
        document.getElementById('sell-submit').disabled = qty > shares || qty < 100;
      }
    }
    
    function executeBuy() {
      const qty = parseInt(document.getElementById('buy-shares').value) || 100;
      const price = getCurrentPrice();
      const cost = price * qty + Math.max(5, price * qty * 0.0003);
      
      if (cost > cash) { showToast('âŒ èµ„é‡‘ä¸è¶³', 'error'); return; }
      if (qty < 100) { showToast('âŒ æœ€å°‘ä¹°å…¥100è‚¡', 'error'); return; }
      
      cash -= cost;
      avgCost = (avgCost * shares + price * qty) / (shares + qty);
      shares += qty;
      tradeCount++;
      
      closeTradeModal('buy');
      showToast(`âœ… ä¹°å…¥ ${qty}è‚¡ @ Â¥${price.toFixed(2)}`, 'success');
      updateUI();
    }
    
    function executeSell() {
      const qty = parseInt(document.getElementById('sell-shares').value) || 100;
      const price = getCurrentPrice();
      
      if (qty > shares) { showToast('âŒ æŒä»“ä¸è¶³', 'error'); return; }
      if (qty < 100) { showToast('âŒ æœ€å°‘å–å‡º100è‚¡', 'error'); return; }
      
      const revenue = price * qty - Math.max(5, price * qty * 0.0003) - price * qty * 0.001;
      const pnl = revenue - avgCost * qty;
      
      cash += revenue;
      shares -= qty;
      if (shares === 0) avgCost = 0;
      tradeCount++;
      if (pnl >= 0) winCount++;
      
      closeTradeModal('sell');
      showToast(pnl >= 0 ? `âœ… ç›ˆåˆ© +Â¥${pnl.toFixed(0)}` : `ğŸ“‰ äºæŸ -Â¥${Math.abs(pnl).toFixed(0)}`, pnl >= 0 ? 'success' : 'error');
      updateUI();
    }
    
    function nextDay() {
      const level = LEVELS[currentLevel];
      dayIndex++;
      if (dayIndex > level.days) { endLevel(); return; }
      updateUI(); analyzeSignals();
    }
    
    function analyzeSignals() {
      const signals = [];
      const dataIdx = 25 + dayIndex - 1;
      const data = priceHistory[dataIdx];
      if (!data) return;
      
      // ä½¿ç”¨é¢„è®¡ç®—çš„é‡æ¯”
      const volRatio = data.volRatio || 1.0;
      
      // é‡ä»·å…³ç³»åˆ†æ
      const isUp = data.change >= 0;
      const isHighVol = volRatio > 1.3;  // æ”¾é‡
      const isLowVol = volRatio < 0.7;   // ç¼©é‡
      
      if (isUp && isHighVol) {
        signals.push({ type: 'buy', text: 'ğŸ”¥ æ”¾é‡ä¸Šæ¶¨(' + (data.change * 100).toFixed(1) + '%)ï¼Œé‡æ¯”' + volRatio.toFixed(2) + 'ï¼Œèµ„é‡‘ç§¯æä¹°å…¥' });
      } else if (!isUp && isHighVol) {
        signals.push({ type: 'sell', text: 'ğŸ’€ æ”¾é‡ä¸‹è·Œ(' + (data.change * 100).toFixed(1) + '%)ï¼Œé‡æ¯”' + volRatio.toFixed(2) + 'ï¼Œèµ„é‡‘å‡ºé€ƒ' });
      } else if (isUp && isLowVol) {
        signals.push({ type: 'warn', text: 'âš ï¸ ç¼©é‡ä¸Šæ¶¨(' + (data.change * 100).toFixed(1) + '%)ï¼Œé‡æ¯”' + volRatio.toFixed(2) + 'ï¼Œç¼ºä¹åŠ¨åŠ›' });
      } else if (!isUp && isLowVol) {
        signals.push({ type: 'warn', text: 'ğŸ¤” ç¼©é‡ä¸‹è·Œ(' + (data.change * 100).toFixed(1) + '%)ï¼Œé‡æ¯”' + volRatio.toFixed(2) + 'ï¼Œå¸‚åœºè§‚æœ›' });
      } else {
        signals.push({ type: '', text: 'ğŸ“Š é‡ä»·æ­£å¸¸ï¼Œé‡æ¯”' + volRatio.toFixed(2) + 'ï¼Œè§‚æœ›ä¸ºä¸»' });
      }
      
      const list = document.getElementById('signal-list');
      list.innerHTML = signals.map(s => `<div class="signal-item ${s.type}">${s.text}</div>`).join('');
    }
    
    function endLevel() {
      const level = LEVELS[currentLevel];
      const finalAssets = cash + shares * getCurrentPrice();
      const profitRate = (finalAssets - initialCash) / initialCash;
      const passed = profitRate >= level.profit;
      let score = 50 + profitRate * 200 + (passed ? 20 : 0);
      score = Math.min(100, Math.max(0, Math.round(score)));
      const grade = score >= 90 ? 'S' : score >= 75 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : 'D';
      
      document.getElementById('report-title').textContent = passed ? 'ğŸ‰ æ­å–œé€šå…³' : 'ğŸ’ª ç»§ç»­åŠªåŠ›';
      document.getElementById('report-profit').textContent = (profitRate >= 0 ? '+' : '') + (profitRate * 100).toFixed(1) + '%';
      document.getElementById('report-profit').style.color = profitRate >= 0 ? 'var(--up)' : 'var(--down)';
      document.getElementById('report-trades').textContent = tradeCount;
      document.getElementById('report-win').textContent = tradeCount > 0 ? Math.round(winCount / tradeCount * 100) + '%' : '--';
      document.getElementById('report-score').textContent = score;
      
      const badge = document.getElementById('grade-badge');
      badge.textContent = grade; badge.className = 'grade-badge grade-' + grade;
      
      if (passed && currentLevel < 4) { unlockedLevels[currentLevel + 1] = true; saveProgress(); }
      showScreen('report');
    }
    
    function nextLevel() {
      if (currentLevel < 4 && unlockedLevels[currentLevel + 1]) startLevel(currentLevel + 1);
      else backToMenu();
    }
    
    function getCurrentPrice() {
      // äº¤æ˜“æ—¥æ•°æ®ä»ç´¢å¼•25å¼€å§‹ï¼ŒdayIndexä»1å¼€å§‹
      const data = priceHistory[25 + dayIndex - 1];
      return data ? data.close : priceHistory[priceHistory.length - 1].close;
    }
    
    function updateUI() {
      const level = LEVELS[currentLevel];
      const price = getCurrentPrice();
      const dataIdx = 25 + dayIndex - 1;
      const data = priceHistory[dataIdx];
      
      document.getElementById('current-price').textContent = 'Â¥' + price.toFixed(2);
      document.getElementById('current-price').className = 'current-price ' + ((data?.change || 0) >= 0 ? 'up' : 'down');
      
      const changeEl = document.getElementById('price-change');
      changeEl.textContent = ((data?.change || 0) >= 0 ? '+' : '') + ((data?.change || 0) * 100).toFixed(2) + '%';
      changeEl.className = (data?.change || 0) >= 0 ? 'up' : 'down';
      document.getElementById('day-volume').textContent = ((data?.volume || 0) / 10000).toFixed(0) + 'ä¸‡';
      
      // é‡æ¯”ç›´æ¥ä½¿ç”¨é¢„è®¡ç®—çš„å€¼
      const volRatio = data?.volRatio || 1.0;
      document.getElementById('vol-ratio').textContent = volRatio.toFixed(2) + 'x';
      
      const totalAssets = cash + shares * price;
      const profitRate = (totalAssets - initialCash) / initialCash;
      document.getElementById('total-assets').textContent = 'Â¥' + totalAssets.toFixed(0);
      document.getElementById('profit-rate').textContent = (profitRate >= 0 ? '+' : '') + (profitRate * 100).toFixed(2) + '%';
      document.getElementById('profit-rate').className = 'profit-rate ' + (profitRate >= 0 ? 'up' : 'down');
      
      document.getElementById('pos-shares').textContent = shares + 'è‚¡';
      document.getElementById('pos-cost').textContent = shares > 0 ? 'Â¥' + avgCost.toFixed(2) : '--';
      const pnlEl = document.getElementById('pos-pnl');
      if (shares > 0) {
        const pnl = (price - avgCost) * shares;
        pnlEl.textContent = (pnl >= 0 ? '+' : '') + 'Â¥' + pnl.toFixed(0);
        pnlEl.style.color = pnl >= 0 ? 'var(--up)' : 'var(--down)';
      } else { pnlEl.textContent = '--'; pnlEl.style.color = ''; }
      
      document.getElementById('day-counter').textContent = dayIndex === 0 ? `ç‚¹å‡»ã€Œä¸‹ä¸€å¤©ã€å¼€å§‹` : `ç¬¬${dayIndex}å¤©/${level.days}å¤©`;
      document.getElementById('progress-fill').style.width = (dayIndex / level.days * 100) + '%';
      
      drawCharts();
    }
    
    const LESSONS = [
      { title: 'ğŸ“š è‚¡ç¥¨æ˜¯ä»€ä¹ˆï¼Ÿ', content: '<p>ä¹°è‚¡ç¥¨å°±æ˜¯æˆä¸ºå…¬å¸çš„<b>"å°è€æ¿"</b></p><p>å¾·æ˜åˆ©æ˜¯åš<span class="hl">å­˜å‚¨èŠ¯ç‰‡</span>çš„å…¬å¸</p><div class="teach-box"><p>âœ… <b>é‡ç‚¹ï¼š</b></p><ul><li>è‚¡ä»· = å¸‚åœºå¯¹å…¬å¸ä»·å€¼çš„çœ‹æ³•</li><li>ç›®æ ‡ï¼šä½ä¹°é«˜å–</li></ul></div>' },
      { title: 'ğŸ“Š Kçº¿å›¾åŸºç¡€', content: '<p><b>çº¢è‰²é˜³çº¿</b> = æ”¶ç›˜ > å¼€ç›˜ = ä¸Šæ¶¨</p><p><b>ç»¿è‰²é˜´çº¿</b> = æ”¶ç›˜ < å¼€ç›˜ = ä¸‹è·Œ</p><div class="teach-box"><p>ğŸ“ˆ <b>å®ä½“</b>ï¼šå¼€ç›˜åˆ°æ”¶ç›˜çš„æ³¢åŠ¨</p><p>ğŸ“ <b>å½±çº¿</b>ï¼šç›˜ä¸­æ³¢åŠ¨èŒƒå›´</p></div>' }
    ];
    
    function showLesson(index) {
      const lesson = LESSONS[index];
      if (!lesson) return;
      document.getElementById('modal-title').textContent = lesson.title;
      document.getElementById('modal-body').innerHTML = lesson.content;
      document.getElementById('teaching-modal').classList.add('show');
    }
    
    function closeModal() { document.getElementById('teaching-modal').classList.remove('show'); }
    
    // ===== æ•™å­¦ç³»ç»Ÿ =====
    function startTeaching(levelIndex) {
      currentLessonIdx = 0;
      currentQuizIdx = 0;
      teachingComplete = false;
      showLessonStep();
    }
    
    function showLessonStep() {
      const level = LEVELS[currentLevel];
      const lessons = level.lessons || [];
      
      if (currentLessonIdx < lessons.length) {
        const lesson = lessons[currentLessonIdx];
        const progress = `çŸ¥è¯†è®²è§£ ${currentLessonIdx + 1}/${lessons.length}`;
        
        document.getElementById('modal-title').textContent = lesson.title;
        document.getElementById('modal-body').innerHTML = lesson.content;
        
        // æ›´æ–°æŒ‰é’®
        const btn = document.getElementById('teaching-btn');
        if (currentLessonIdx >= lessons.length - 1) {
          btn.textContent = 'å¼€å§‹æµ‹éªŒ â–¶';
          btn.onclick = () => {
            currentLessonIdx++;
            startQuiz();
          };
        } else {
          btn.textContent = 'ä¸‹ä¸€é¡µ â–¶';
          btn.onclick = () => {
            currentLessonIdx++;
            showLessonStep();
          };
        }
        
        document.getElementById('teaching-modal').classList.add('show');
      } else {
        startQuiz();
      }
    }
    
    function startQuiz() {
      const level = LEVELS[currentLevel];
      const quiz = level.quiz || [];
      
      if (quiz.length > 0 && currentQuizIdx < quiz.length) {
        showQuizStep();
      } else {
        finishTeaching();
      }
    }
    
    function showQuizStep() {
      const level = LEVELS[currentLevel];
      const quiz = level.quiz || [];
      const q = quiz[currentQuizIdx];
      
      if (!q) { finishTeaching(); return; }
      
      const progress = `ğŸ“ å°æµ‹éªŒ ${currentQuizIdx + 1}/${quiz.length}`;
      
      let optionsHtml = q.options.map((opt, i) => 
        `<button class="quiz-option" data-idx="${i}" style="display:block;width:100%;background:var(--bg-3);border:1px solid var(--bg-4);border-radius:8px;padding:12px;margin:8px 0;text-align:left;color:var(--text-1);cursor:pointer;">
          <span style="display:inline-block;width:24px;height:24px;background:var(--accent);border-radius:50%;text-align:center;line-height:24px;margin-right:10px;font-weight:600;color:#000;">${'ABC'[i]}</span>
          ${opt}
        </button>`
      ).join('');
      
      document.getElementById('modal-title').textContent = progress;
      document.getElementById('modal-body').innerHTML = `
        <p style="font-size:15px;margin-bottom:16px;font-weight:600;">${q.question}</p>
        <div id="quiz-options">${optionsHtml}</div>
        <div id="quiz-result" style="margin-top:16px;"></div>
      `;
      
      // éšè—åº•éƒ¨æŒ‰é’®ï¼ˆæµ‹éªŒæ—¶ç”¨é€‰é¡¹æŒ‰é’®ï¼‰
      document.getElementById('teaching-btn').style.display = 'none';
      
      // ç»‘å®šé€‰é¡¹ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.quiz-option').forEach(btn => {
        btn.addEventListener('click', () => checkAnswer(parseInt(btn.dataset.idx)));
      });
      
      document.getElementById('teaching-modal').classList.add('show');
    }
    
    function checkAnswer(selectedIdx) {
      const level = LEVELS[currentLevel];
      const quiz = level.quiz || [];
      const q = quiz[currentQuizIdx];
      const correct = selectedIdx === q.answer;
      
      // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
      document.querySelectorAll('.quiz-option').forEach((btn, i) => {
        btn.disabled = true;
        btn.style.opacity = '0.7';
        if (i === q.answer) {
          btn.style.borderColor = 'var(--down)';
          btn.style.background = 'rgba(34,197,94,0.2)';
        }
        if (i === selectedIdx && !correct) {
          btn.style.borderColor = 'var(--up)';
          btn.style.background = 'rgba(239,68,68,0.2)';
        }
      });
      
      const resultEl = document.getElementById('quiz-result');
      resultEl.innerHTML = `
        <div style="padding:12px;background:${correct ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)'};border-radius:8px;border-left:3px solid ${correct ? 'var(--down)' : 'var(--up)'};">
          <div style="font-weight:600;margin-bottom:8px;">${correct ? 'âœ… å›ç­”æ­£ç¡®ï¼' : 'âŒ å›ç­”é”™è¯¯'}</div>
          <div style="font-size:13px;color:var(--text-2);">${q.explanation}</div>
        </div>
        <button id="quiz-next-btn" class="btn-primary" style="margin-top:16px;">
          ${currentQuizIdx < quiz.length - 1 ? 'ä¸‹ä¸€é¢˜ â–¶' : 'å¼€å§‹å®æˆ˜ ğŸš€'}
        </button>
      `;
      
      document.getElementById('quiz-next-btn').addEventListener('click', nextQuiz);
    }
    
    function nextQuiz() {
      currentQuizIdx++;
      const level = LEVELS[currentLevel];
      const quiz = level.quiz || [];
      
      if (currentQuizIdx < quiz.length) {
        showQuizStep();
      } else {
        finishTeaching();
      }
    }
    
    function finishTeaching() {
      document.getElementById('teaching-modal').classList.remove('show');
      document.getElementById('teaching-btn').style.display = 'block';
      teachingComplete = true;
      showToast('ğŸ“– æ•™å­¦å®Œæˆï¼Œå¼€å§‹äº¤æ˜“ï¼', 'success');
    }
    function showScreen(name) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(name + '-screen').classList.add('active');
    }
    function backToMenu() { showScreen('menu'); renderLevelGrid(); }
    function showToast(msg, type = '') {
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 1800);
    }
    
    init();
  </script>
</body>
</html>

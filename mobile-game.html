<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0a0e17">
  <title>è‚¡æ°‘é—¯å…³ï¼šå¾·æ˜åˆ©å®æˆ˜</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    :root {
      --bg-1: #0a0e17;
      --bg-2: #111827;
      --bg-3: #1e293b;
      --bg-4: #334155;
      --text-1: #f1f5f9;
      --text-2: #94a3b8;
      --text-3: #64748b;
      --up: #ef4444;
      --down: #22c55e;
      --accent: #3b82f6;
      --gold: #eab308;
    }
    
    html, body {
      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background: var(--bg-1);
      color: var(--text-1);
      font-size: 14px;
      min-height: 100vh;
      touch-action: manipulation;
    }
    
    .safe-top { padding-top: env(safe-area-inset-top, 12px); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 12px); }
    
    .screen { display: none; min-height: 100vh; }
    .screen.active { display: flex; flex-direction: column; }
    
    /* ===== ä¸»èœå• ===== */
    .menu-screen {
      background: var(--bg-1);
      padding: 20px 16px;
    }
    
    .menu-header {
      text-align: center;
      padding: 24px 0 20px;
    }
    
    .menu-title {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, #f59e0b, #ef4444, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }
    
    .menu-subtitle {
      color: var(--text-3);
      font-size: 12px;
    }
    
    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 32px;
      padding: 16px;
      margin: 16px 0;
      background: var(--bg-2);
      border-radius: 12px;
    }
    
    .stat-item { text-align: center; }
    .stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 11px; color: var(--text-3); margin-top: 4px; }
    
    .level-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .level-card {
      background: var(--bg-2);
      border: 1px solid var(--bg-4);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all .2s;
    }
    
    .level-card:active {
      border-color: var(--accent);
      transform: scale(0.98);
    }
    
    .level-card.locked { opacity: 0.4; pointer-events: none; }
    .level-card.completed { border-color: var(--gold); }
    
    .level-header {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      margin-bottom: 10px;
    }
    
    .level-num {
      font-size: 36px;
      font-weight: 900;
      color: var(--accent);
      line-height: 1;
    }
    
    .level-info h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .level-info p {
      font-size: 12px;
      color: var(--text-3);
    }
    
    .level-meta {
      display: flex;
      gap: 16px;
      font-size: 11px;
      color: var(--text-3);
      padding-left: 50px;
    }
    
    .level-target {
      color: var(--up);
      font-weight: 600;
    }
    
    /* ===== æ¸¸æˆç•Œé¢ ===== */
    .game-screen { background: var(--bg-1); }
    
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: var(--bg-2);
      border-bottom: 1px solid var(--bg-4);
    }
    
    .back-btn {
      background: none;
      border: 1px solid var(--bg-4);
      color: var(--text-2);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .level-badge {
      font-weight: 700;
      color: var(--accent);
      font-size: 14px;
    }
    
    .assets-display { text-align: right; }
    .total-assets { font-size: 16px; font-weight: 600; }
    .profit-rate { font-size: 12px; }
    .profit-rate.up { color: var(--up); }
    .profit-rate.down { color: var(--down); }
    
    /* ä»·æ ¼æ˜¾ç¤º */
    .price-section {
      background: var(--bg-2);
      padding: 20px 16px;
      text-align: center;
      border-bottom: 1px solid var(--bg-4);
    }
    
    .stock-name {
      font-size: 13px;
      color: var(--text-2);
      margin-bottom: 6px;
    }
    
    .current-price {
      font-size: 36px;
      font-weight: 800;
      margin-bottom: 8px;
    }
    
    .current-price.up { color: var(--up); }
    .current-price.down { color: var(--down); }
    
    .price-meta {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 12px;
      color: var(--text-3);
    }
    
    .price-meta b.up { color: var(--up); }
    .price-meta b.down { color: var(--down); }
    
    /* Kçº¿å›¾ */
    .chart-section {
      background: var(--bg-1);
      padding: 12px 16px;
      border-bottom: 1px solid var(--bg-4);
    }
    
    .chart-title {
      font-size: 12px;
      color: var(--text-2);
      margin-bottom: 8px;
    }
    
    .chart-canvas {
      width: 100%;
      height: 150px;
      background: var(--bg-2);
      border-radius: 8px;
    }
    
    /* ä¿¡å·åŒº */
    .signal-section {
      background: var(--bg-2);
      padding: 12px 16px;
      border-bottom: 1px solid var(--bg-4);
    }
    
    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-2);
      margin-bottom: 10px;
    }
    
    .signal-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .signal-item {
      background: var(--bg-3);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 12px;
      border-left: 3px solid var(--text-3);
    }
    
    .signal-item.buy { border-color: var(--up); background: rgba(239,68,68,0.1); }
    .signal-item.sell { border-color: var(--down); background: rgba(34,197,94,0.1); }
    .signal-item.warn { border-color: var(--gold); background: rgba(234,179,8,0.1); }
    
    /* æŒä»“ */
    .position-section {
      background: var(--bg-2);
      padding: 14px 16px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      border-bottom: 1px solid var(--bg-4);
    }
    
    .pos-item { text-align: center; }
    .pos-label { font-size: 11px; color: var(--text-3); margin-bottom: 4px; }
    .pos-value { font-size: 14px; font-weight: 600; }
    
    /* äº¤æ˜“åŒº */
    .trade-section {
      background: var(--bg-2);
      padding: 16px;
      border-top: 1px solid var(--bg-4);
    }
    
    .trade-input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .trade-input {
      flex: 1;
      background: var(--bg-3);
      border: 1px solid var(--bg-4);
      border-radius: 8px;
      padding: 12px;
      color: var(--text-1);
      font-size: 16px;
      text-align: center;
    }
    
    .qty-btns { display: flex; gap: 6px; }
    
    .qty-btn {
      background: var(--bg-3);
      border: 1px solid var(--bg-4);
      border-radius: 6px;
      padding: 10px 12px;
      color: var(--text-1);
      font-size: 12px;
      cursor: pointer;
    }
    
    .qty-btn:active { background: var(--bg-4); }
    
    .trade-btns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .btn-buy {
      background: var(--up);
      border: none;
      border-radius: 8px;
      padding: 14px;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn-sell {
      background: var(--down);
      border: none;
      border-radius: 8px;
      padding: 14px;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn-buy:active, .btn-sell:active { opacity: 0.85; }
    
    .quick-btns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    
    .btn-quick {
      background: var(--bg-3);
      border: 1px solid var(--bg-4);
      border-radius: 6px;
      padding: 10px;
      color: var(--text-2);
      font-size: 12px;
      cursor: pointer;
    }
    
    .btn-quick:active { background: var(--bg-4); color: var(--text-1); }
    
    /* åº•éƒ¨ */
    .game-footer {
      background: var(--bg-2);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--bg-4);
    }
    
    .day-progress {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .day-counter {
      font-size: 13px;
      color: var(--text-1);
    }
    
    .progress-bar {
      width: 100px;
      height: 4px;
      background: var(--bg-4);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s;
    }
    
    .next-day-btn {
      background: var(--accent);
      border: none;
      border-radius: 20px;
      padding: 12px 24px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .next-day-btn:active { opacity: 0.9; }
    
    /* Toast */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-2);
      border: 1px solid var(--bg-4);
      border-radius: 12px;
      padding: 16px 24px;
      text-align: center;
      z-index: 1000;
      animation: fadeIn 0.2s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    
    .toast.success { border-color: var(--down); }
    .toast.error { border-color: var(--up); }
    
    /* å¼¹çª— */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }
    
    .modal.show { display: flex; }
    
    .modal-content {
      background: var(--bg-2);
      border: 1px solid var(--bg-4);
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
      color: var(--accent);
    }
    
    .modal-body {
      font-size: 14px;
      line-height: 1.8;
      margin-bottom: 20px;
      color: var(--text-1);
    }
    
    .modal-body p { margin-bottom: 12px; }
    .modal-body ul { padding-left: 20px; margin-bottom: 12px; }
    .modal-body li { margin-bottom: 6px; }
    .modal-body .hl { color: var(--gold); font-weight: 600; }
    .modal-body b { color: var(--accent); }
    
    .teach-box {
      background: var(--bg-3);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    
    .btn-primary {
      background: var(--accent);
      border: none;
      border-radius: 8px;
      padding: 14px;
      width: 100%;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn-primary:active { opacity: 0.9; }
    
    /* ç»“ç®— */
    .report-screen {
      background: var(--bg-1);
      padding: 40px 20px;
      text-align: center;
    }
    
    .report-title {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 24px;
    }
    
    .report-card {
      background: var(--bg-2);
      border: 1px solid var(--bg-4);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .grade-badge {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      font-weight: 800;
      margin: 0 auto 20px;
    }
    
    .grade-S { background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; }
    .grade-A { background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; }
    .grade-B { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; }
    .grade-C { background: linear-gradient(135deg, #eab308, #ca8a04); color: #000; }
    .grade-D { background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; }
    
    .report-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .report-stats .stat-item {
      background: var(--bg-3);
      padding: 14px;
      border-radius: 8px;
    }
    
    .report-stats .stat-value {
      font-size: 20px;
      font-weight: 700;
    }
    
    .report-stats .stat-label {
      font-size: 11px;
      color: var(--text-3);
      margin-top: 4px;
    }
    
    .report-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn-secondary {
      background: var(--bg-3);
      border: 1px solid var(--bg-4);
      border-radius: 8px;
      padding: 14px;
      width: 100%;
      color: var(--text-1);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- ä¸»èœå• -->
  <div id="menu-screen" class="screen menu-screen active">
    <div class="safe-top"></div>
    <div class="menu-header">
      <div class="menu-title">ğŸ“ˆ è‚¡æ°‘é—¯å…³ï¼šå¾·æ˜åˆ©å®æˆ˜</div>
      <div class="menu-subtitle">ä»é›¶å¼€å§‹ï¼Œ5å…³ç³»ç»Ÿå­¦ä¹ Aè‚¡äº¤æ˜“</div>
    </div>
    
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value">5</div>
        <div class="stat-label">å…³å¡</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">50</div>
        <div class="stat-label">å¤©æ•°</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="completed-levels">0</div>
        <div class="stat-label">å·²é€šå…³</div>
      </div>
    </div>
    
    <div class="level-grid" id="level-grid"></div>
    <div class="safe-bottom"></div>
  </div>
  
  <!-- æ¸¸æˆç•Œé¢ -->
  <div id="game-screen" class="screen game-screen">
    <div class="safe-top"></div>
    
    <div class="game-header">
      <button class="back-btn" onclick="backToMenu()">â—€ è¿”å›</button>
      <span class="level-badge" id="level-badge">ç¬¬1å…³</span>
      <div class="assets-display">
        <div class="total-assets" id="total-assets">Â¥100,000</div>
        <div class="profit-rate" id="profit-rate">+0.00%</div>
      </div>
    </div>
    
    <div class="price-section">
      <div class="stock-name">å¾·æ˜åˆ© 001309</div>
      <div class="current-price up" id="current-price">Â¥250.00</div>
      <div class="price-meta">
        <span>æ¶¨è·Œ <b id="price-change">+0.00%</b></span>
        <span>é‡ <b id="day-volume">0ä¸‡</b></span>
        <span>é‡æ¯” <b id="vol-ratio">1.0x</b></span>
      </div>
    </div>
    
    <div class="chart-section">
      <div class="chart-title">ğŸ“Š Kçº¿å›¾</div>
      <canvas id="chart-canvas" class="chart-canvas"></canvas>
    </div>
    
    <div class="signal-section">
      <div class="section-title">ğŸ“¡ é‡ä»·ä¿¡å·</div>
      <div class="signal-list" id="signal-list">
        <div class="signal-item">ç‚¹å‡»ã€Œä¸‹ä¸€å¤©ã€å¼€å§‹</div>
      </div>
    </div>
    
    <div class="position-section">
      <div class="pos-item">
        <div class="pos-label">æŒä»“</div>
        <div class="pos-value" id="pos-shares">0è‚¡</div>
      </div>
      <div class="pos-item">
        <div class="pos-label">æˆæœ¬</div>
        <div class="pos-value" id="pos-cost">--</div>
      </div>
      <div class="pos-item">
        <div class="pos-label">æµ®åŠ¨ç›ˆäº</div>
        <div class="pos-value" id="pos-pnl">--</div>
      </div>
    </div>
    
    <div class="trade-section">
      <div class="trade-input-row">
        <input type="number" class="trade-input" id="trade-shares" value="100" step="100" min="100">
        <div class="qty-btns">
          <button class="qty-btn" onclick="setQty(100)">1æ‰‹</button>
          <button class="qty-btn" onclick="setQty(500)">5æ‰‹</button>
          <button class="qty-btn" onclick="setQty(1000)">10æ‰‹</button>
        </div>
      </div>
      <div class="trade-btns">
        <button class="btn-buy" onclick="buy()">ä¹°å…¥</button>
        <button class="btn-sell" onclick="sell()">å–å‡º</button>
      </div>
      <div class="quick-btns">
        <button class="btn-quick" onclick="buyMax()">å…¨ä»“ä¹°</button>
        <button class="btn-quick" onclick="sellAll()">æ¸…ä»“å–</button>
      </div>
    </div>
    
    <div class="game-footer safe-bottom">
      <div class="day-progress">
        <div class="day-counter" id="day-counter">ç¬¬0å¤©/5å¤©</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width:0%"></div>
        </div>
      </div>
      <button class="next-day-btn" onclick="nextDay()">ä¸‹ä¸€å¤© â–¶</button>
    </div>
  </div>
  
  <!-- æ•™å­¦å¼¹çª— -->
  <div id="teaching-modal" class="modal">
    <div class="modal-content">
      <div class="modal-title" id="modal-title">ğŸ“š æ•™å­¦</div>
      <div class="modal-body" id="modal-body"></div>
      <button class="btn-primary" onclick="closeModal()">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>
  
  <!-- ç»“ç®—ç•Œé¢ -->
  <div id="report-screen" class="screen report-screen">
    <div class="safe-top"></div>
    <div class="report-title" id="report-title">ğŸ‰ æ­å–œé€šå…³</div>
    <div class="report-card">
      <div class="grade-badge" id="grade-badge">A</div>
      <div class="report-stats">
        <div class="stat-item">
          <div class="stat-value" id="report-profit">+5.2%</div>
          <div class="stat-label">æ”¶ç›Šç‡</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="report-trades">3</div>
          <div class="stat-label">äº¤æ˜“æ¬¡æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="report-win">66%</div>
          <div class="stat-label">èƒœç‡</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="report-score">85</div>
          <div class="stat-label">ç»¼åˆè¯„åˆ†</div>
        </div>
      </div>
    </div>
    <div class="report-actions">
      <button class="btn-primary" onclick="nextLevel()">ä¸‹ä¸€å…³ â–¶</button>
      <button class="btn-secondary" onclick="backToMenu()">è¿”å›èœå•</button>
    </div>
    <div class="safe-bottom"></div>
  </div>
  
  <script>
    // ===== æ¸¸æˆçŠ¶æ€ =====
    let currentLevel = 0, dayIndex = 0, cash = 100000, initialCash = 100000;
    let shares = 0, avgCost = 0, tradeCount = 0, winCount = 0;
    let priceHistory = [];
    let unlockedLevels = [true, false, false, false, false];
    
    // ===== å…³å¡é…ç½® =====
    const LEVELS = [
      { id: 1, title: 'è®¤è¯†å¸‚åœºåŸºç¡€', subtitle: 'å­¦ä¹ Kçº¿å›¾çš„è¯­è¨€', days: 5, profit: 0.05, price: 250, cash: 100000 },
      { id: 2, title: 'æˆäº¤é‡åˆ†æ', subtitle: 'å¸‚åœºçš„"å¿ƒè·³"', days: 8, profit: 0.08, price: 240, cash: 100000 },
      { id: 3, title: 'å‡çº¿ç³»ç»Ÿ', subtitle: '5æ—¥ã€10æ—¥ã€20æ—¥çº¿', days: 10, profit: 0.10, price: 230, cash: 100000 },
      { id: 4, title: 'æ”¯æ’‘ä¸å‹åŠ›', subtitle: 'åœ°æ¿ä¸å¤©èŠ±æ¿', days: 12, profit: 0.12, price: 225, cash: 120000 },
      { id: 5, title: 'å®æˆ˜äº¤æ˜“ç³»ç»Ÿ', subtitle: 'ç»¼åˆè¿ç”¨', days: 15, profit: 0.15, price: 220, cash: 150000 },
    ];
    
    // ===== åˆå§‹åŒ– =====
    function init() {
      loadProgress();
      renderLevelGrid();
    }
    
    function loadProgress() {
      const saved = localStorage.getItem('stockgame_v3');
      if (saved) unlockedLevels = JSON.parse(saved).unlocked || unlockedLevels;
    }
    
    function saveProgress() {
      localStorage.setItem('stockgame_v3', JSON.stringify({ unlocked: unlockedLevels }));
    }
    
    function renderLevelGrid() {
      document.getElementById('completed-levels').textContent = unlockedLevels.filter((v, i) => i > 0 && v).length;
      document.getElementById('level-grid').innerHTML = LEVELS.map((level, i) => `
        <div class="level-card ${unlockedLevels[i] ? '' : 'locked'} ${unlockedLevels[i+1] ? 'completed' : ''}" onclick="startLevel(${i})">
          <div class="level-header">
            <div class="level-num">${level.id}</div>
            <div class="level-info">
              <h3>${level.title}</h3>
              <p>${level.subtitle}</p>
            </div>
          </div>
          <div class="level-meta">
            <span>${level.days}å¤©</span>
            <span class="level-target">ç›®æ ‡+${(level.profit * 100).toFixed(0)}%</span>
            <span>Â¥${(level.cash/10000).toFixed(0)}ä¸‡</span>
          </div>
        </div>
      `).join('');
    }
    
    function startLevel(levelIndex) {
      if (!unlockedLevels[levelIndex]) { showToast('ğŸ”’ æœªè§£é”', 'error'); return; }
      
      currentLevel = levelIndex;
      const level = LEVELS[levelIndex];
      dayIndex = 0; cash = level.cash; initialCash = level.cash;
      shares = 0; avgCost = 0; tradeCount = 0; winCount = 0;
      
      generatePriceData(level);
      document.getElementById('level-badge').textContent = `ç¬¬${level.id}å…³`;
      showScreen('game');
      updateUI();
      if (levelIndex === 0) setTimeout(() => showLesson(0), 500);
    }
    
    function generatePriceData(level) {
      priceHistory = [];
      let price = level.price;
      for (let i = 0; i < 20; i++) {
        const change = (Math.random() - 0.48) * 0.03;
        price = price * (1 + change);
        priceHistory.push({
          open: price * (1 + (Math.random() - 0.5) * 0.01),
          high: price * (1 + Math.random() * 0.02),
          low: price * (1 - Math.random() * 0.02),
          close: price, volume: 500000 + Math.random() * 500000, change
        });
      }
      
      const trends = ['up', 'up', 'down', 'up', 'up', 'down', 'up'];
      let dayPrice = priceHistory[priceHistory.length - 1].close;
      for (let d = 0; d < level.days; d++) {
        const trend = trends[d % trends.length];
        const strength = 0.01 + Math.random() * 0.025;
        let change = trend === 'up' ? strength : -strength;
        change += (Math.random() - 0.5) * 0.01;
        dayPrice = dayPrice * (1 + change);
        priceHistory.push({
          open: dayPrice * (1 + (Math.random() - 0.5) * 0.01),
          high: dayPrice * (1 + Math.random() * 0.015),
          low: dayPrice * (1 - Math.random() * 0.015),
          close: dayPrice, volume: 500000 + Math.random() * 1000000 * (Math.abs(change) > 0.02 ? 1.5 : 1),
          change, isTradingDay: true
        });
      }
    }
    
    function buy() {
      const qty = parseInt(document.getElementById('trade-shares').value) || 100;
      const price = getCurrentPrice();
      const cost = price * qty + Math.max(5, price * qty * 0.0003);
      if (cost > cash) { showToast('âŒ èµ„é‡‘ä¸è¶³', 'error'); return; }
      if (qty < 100) { showToast('âŒ æœ€å°‘ä¹°å…¥100è‚¡', 'error'); return; }
      cash -= cost;
      avgCost = (avgCost * shares + price * qty) / (shares + qty);
      shares += qty; tradeCount++;
      showToast(`âœ… ä¹°å…¥ ${qty}è‚¡ @ Â¥${price.toFixed(2)}`, 'success');
      updateUI();
    }
    
    function sell() {
      const qty = parseInt(document.getElementById('trade-shares').value) || 100;
      const price = getCurrentPrice();
      if (qty > shares) { showToast('âŒ æŒä»“ä¸è¶³', 'error'); return; }
      if (qty < 100) { showToast('âŒ æœ€å°‘å–å‡º100è‚¡', 'error'); return; }
      const revenue = price * qty - Math.max(5, price * qty * 0.0003) - price * qty * 0.001;
      const pnl = revenue - avgCost * qty;
      cash += revenue; shares -= qty;
      if (shares === 0) avgCost = 0;
      tradeCount++; if (pnl >= 0) winCount++;
      showToast(pnl >= 0 ? `âœ… ç›ˆåˆ© +Â¥${pnl.toFixed(0)}` : `ğŸ“‰ äºæŸ -Â¥${Math.abs(pnl).toFixed(0)}`, pnl >= 0 ? 'success' : 'error');
      updateUI();
    }
    
    function buyMax() {
      const price = getCurrentPrice();
      const maxQty = Math.floor(cash / (price * 1.001));
      const qty = maxQty - (maxQty % 100);
      if (qty >= 100) { document.getElementById('trade-shares').value = qty; buy(); }
    }
    
    function sellAll() { if (shares >= 100) { document.getElementById('trade-shares').value = shares; sell(); } }
    function setQty(qty) { document.getElementById('trade-shares').value = qty; }
    
    function nextDay() {
      const level = LEVELS[currentLevel];
      dayIndex++;
      if (dayIndex >= level.days) { endLevel(); return; }
      updateUI(); analyzeSignals();
    }
    
    function analyzeSignals() {
      const signals = [];
      const data = priceHistory[20 + dayIndex];
      if (!data) return;
      if (data.change > 0 && data.volume > 800000) signals.push({ type: 'buy', text: 'ğŸ”¥ æ”¾é‡ä¸Šæ¶¨ï¼Œèµ„é‡‘ç§¯æä¹°å…¥' });
      else if (data.change < 0 && data.volume > 800000) signals.push({ type: 'sell', text: 'ğŸ’€ æ”¾é‡ä¸‹è·Œï¼Œèµ„é‡‘å‡ºé€ƒ' });
      else if (data.change > 0 && data.volume < 400000) signals.push({ type: 'warn', text: 'âš ï¸ ç¼©é‡ä¸Šæ¶¨ï¼Œç¼ºä¹åŠ¨åŠ›' });
      
      const list = document.getElementById('signal-list');
      list.innerHTML = signals.length ? signals.map(s => `<div class="signal-item ${s.type}">${s.text}</div>`).join('') : '<div class="signal-item">æš‚æ— æ˜ç¡®ä¿¡å·</div>';
    }
    
    function endLevel() {
      const level = LEVELS[currentLevel];
      const finalAssets = cash + shares * getCurrentPrice();
      const profitRate = (finalAssets - initialCash) / initialCash;
      const passed = profitRate >= level.profit;
      let score = 50 + profitRate * 200 + (passed ? 20 : 0);
      score = Math.min(100, Math.max(0, Math.round(score)));
      const grade = score >= 90 ? 'S' : score >= 75 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : 'D';
      
      document.getElementById('report-title').textContent = passed ? 'ğŸ‰ æ­å–œé€šå…³' : 'ğŸ’ª ç»§ç»­åŠªåŠ›';
      document.getElementById('report-profit').textContent = (profitRate >= 0 ? '+' : '') + (profitRate * 100).toFixed(1) + '%';
      document.getElementById('report-profit').style.color = profitRate >= 0 ? 'var(--up)' : 'var(--down)';
      document.getElementById('report-trades').textContent = tradeCount;
      document.getElementById('report-win').textContent = tradeCount > 0 ? Math.round(winCount / tradeCount * 100) + '%' : '--';
      document.getElementById('report-score').textContent = score;
      
      const badge = document.getElementById('grade-badge');
      badge.textContent = grade; badge.className = 'grade-badge grade-' + grade;
      
      if (passed && currentLevel < 4) { unlockedLevels[currentLevel + 1] = true; saveProgress(); }
      showScreen('report');
    }
    
    function nextLevel() {
      if (currentLevel < 4 && unlockedLevels[currentLevel + 1]) startLevel(currentLevel + 1);
      else backToMenu();
    }
    
    function getCurrentPrice() {
      const data = priceHistory[20 + dayIndex];
      return data ? data.close : priceHistory[priceHistory.length - 1].close;
    }
    
    function updateUI() {
      const level = LEVELS[currentLevel];
      const price = getCurrentPrice();
      const data = priceHistory[20 + dayIndex];
      
      document.getElementById('current-price').textContent = 'Â¥' + price.toFixed(2);
      document.getElementById('current-price').className = 'current-price ' + ((data?.change || 0) >= 0 ? 'up' : 'down');
      
      const changeEl = document.getElementById('price-change');
      changeEl.textContent = ((data?.change || 0) >= 0 ? '+' : '') + ((data?.change || 0) * 100).toFixed(2) + '%';
      changeEl.className = (data?.change || 0) >= 0 ? 'up' : 'down';
      document.getElementById('day-volume').textContent = ((data?.volume || 0) / 10000).toFixed(0) + 'ä¸‡';
      document.getElementById('vol-ratio').textContent = ((data?.volume || 500000) / 500000).toFixed(1) + 'x';
      
      const totalAssets = cash + shares * price;
      const profitRate = (totalAssets - initialCash) / initialCash;
      document.getElementById('total-assets').textContent = 'Â¥' + totalAssets.toFixed(0);
      document.getElementById('profit-rate').textContent = (profitRate >= 0 ? '+' : '') + (profitRate * 100).toFixed(2) + '%';
      document.getElementById('profit-rate').className = 'profit-rate ' + (profitRate >= 0 ? 'up' : 'down');
      
      document.getElementById('pos-shares').textContent = shares + 'è‚¡';
      document.getElementById('pos-cost').textContent = shares > 0 ? 'Â¥' + avgCost.toFixed(2) : '--';
      const pnlEl = document.getElementById('pos-pnl');
      if (shares > 0) {
        const pnl = (price - avgCost) * shares;
        pnlEl.textContent = (pnl >= 0 ? '+' : '') + 'Â¥' + pnl.toFixed(0);
        pnlEl.style.color = pnl >= 0 ? 'var(--up)' : 'var(--down)';
      } else { pnlEl.textContent = '--'; pnlEl.style.color = ''; }
      
      document.getElementById('day-counter').textContent = `ç¬¬${dayIndex}å¤©/${level.days}å¤©`;
      document.getElementById('progress-fill').style.width = (dayIndex / level.days * 100) + '%';
      
      drawChart();
    }
    
    function drawChart() {
      const canvas = document.getElementById('chart-canvas');
      const ctx = canvas.getContext('2d');
      const w = canvas.offsetWidth, h = canvas.offsetHeight;
      canvas.width = w * 2; canvas.height = h * 2;
      ctx.scale(2, 2);
      ctx.fillStyle = '#111827'; ctx.fillRect(0, 0, w, h);
      
      const visibleData = priceHistory.slice(0, 21 + dayIndex);
      if (visibleData.length < 2) return;
      
      const prices = visibleData.flatMap(d => [d.high, d.low]);
      const minPrice = Math.min(...prices), maxPrice = Math.max(...prices);
      const priceRange = maxPrice - minPrice || 1;
      const candleWidth = (w - 20) / visibleData.length;
      
      visibleData.forEach((d, i) => {
        const x = 10 + i * candleWidth;
        const isUp = d.close >= d.open;
        ctx.strokeStyle = isUp ? '#ef4444' : '#22c55e';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x + candleWidth / 2, ((maxPrice - d.high) / priceRange) * (h - 20) + 10);
        ctx.lineTo(x + candleWidth / 2, ((maxPrice - d.low) / priceRange) * (h - 20) + 10);
        ctx.stroke();
        
        const openY = ((maxPrice - d.open) / priceRange) * (h - 20) + 10;
        const closeY = ((maxPrice - d.close) / priceRange) * (h - 20) + 10;
        ctx.fillStyle = isUp ? '#ef4444' : '#22c55e';
        ctx.fillRect(x + 1, Math.min(openY, closeY), candleWidth - 2, Math.max(1, Math.abs(closeY - openY)));
      });
    }
    
    const LESSONS = [
      { title: 'ğŸ“š è‚¡ç¥¨æ˜¯ä»€ä¹ˆï¼Ÿ', content: '<p>ä¹°è‚¡ç¥¨å°±æ˜¯æˆä¸ºå…¬å¸çš„<b>"å°è€æ¿"</b></p><p>å¾·æ˜åˆ©æ˜¯åš<span class="hl">å­˜å‚¨èŠ¯ç‰‡</span>çš„å…¬å¸ï¼Œä½ ä¹°å…¥å®ƒçš„è‚¡ç¥¨ï¼Œå°±æ‹¥æœ‰äº†å…¬å¸çš„ä¸€éƒ¨åˆ†ã€‚</p><div class="teach-box"><p>âœ… <b>é‡ç‚¹ï¼š</b></p><ul><li>è‚¡ä»· = å¸‚åœºå¯¹å…¬å¸ä»·å€¼çš„çœ‹æ³•</li><li>ä½ çš„ç›®æ ‡ï¼šä½ä»·ä¹°å…¥ï¼Œé«˜ä»·å–å‡º</li></ul></div>' },
      { title: 'ğŸ“Š Kçº¿å›¾åŸºç¡€', content: '<p><b>çº¢è‰²é˜³çº¿</b> = æ”¶ç›˜ä»· > å¼€ç›˜ä»· = ä¸Šæ¶¨</p><p><b>ç»¿è‰²é˜´çº¿</b> = æ”¶ç›˜ä»· < å¼€ç›˜ä»· = ä¸‹è·Œ</p><div class="teach-box"><p>ğŸ“ˆ <b>å®ä½“éƒ¨åˆ†</b>ï¼šå¼€ç›˜ä»·åˆ°æ”¶ç›˜ä»·çš„æ³¢åŠ¨</p><p>ğŸ“ <b>ä¸Šä¸‹å½±çº¿</b>ï¼šç›˜ä¸­æœ€é«˜ä»·å’Œæœ€ä½ä»·çš„æ³¢åŠ¨</p></div>' }
    ];
    
    function showLesson(index) {
      const lesson = LESSONS[index];
      if (!lesson) return;
      document.getElementById('modal-title').textContent = lesson.title;
      document.getElementById('modal-body').innerHTML = lesson.content;
      document.getElementById('teaching-modal').classList.add('show');
    }
    
    function closeModal() { document.getElementById('teaching-modal').classList.remove('show'); }
    function showScreen(name) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(name + '-screen').classList.add('active');
    }
    function backToMenu() { showScreen('menu'); renderLevelGrid(); }
    function showToast(msg, type = '') {
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 1800);
    }
    
    init();
  </script>
</body>
</html>
